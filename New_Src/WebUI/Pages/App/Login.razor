@page "/"
@page "/login"
@using MudBlazor
@using WebUI.Services
@inject NavigationManager NavManager
@inject ISnackbar Snackbar
@inject AuthService AuthService

<PageTitle>ICP - Login</PageTitle>

<div class="login-container">
    <div class="login-wrapper">
        <div class="login-logo-panel">
            <div class="text-center">
                <div class="login-logo-text">
                    <img src="Images/logo-RASF1.png" width="180" />
                </div>
                <div class="login-logo-subtitle">Razi Applied Science Foundation</div>
            </div>
        </div>

        <div class="login-form-panel">
            <div class="login-form-card">
                <MudText Typo="Typo.caption" Class="mud-text-secondary">Welcome back</MudText>
                <MudText Typo="Typo.h4" Align="Align.Left" Class="login-welcome-title">Sign in to ICP</MudText>

                <MudForm @ref="loginForm" @bind-IsValid="loginValid">
                    <MudTextField @bind-Value="loginUsername"
                                  Label="Username"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Username is required"
                                  Class="mb-4" />

                    <MudTextField @bind-Value="loginPassword"
                                  Label="Password"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Password"
                                  Required="true"
                                  RequiredError="Password is required"
                                  Class="mb-4" />

                    <MudCheckBox @bind-Value="rememberMe"
                                 Label="Remember Me"
                                 Color="Color.Primary"
                                 Size="Size.Small"
                                 Class="mb-3" />

                    <MudButton Variant="Variant.Filled"
                               Size="Size.Large"
                               FullWidth="true"
                               OnClick="HandleLogin"
                               Disabled="@(!loginValid || loginProcessing)"
                               Class="login-btn mb-3">
                        @if (loginProcessing)
                        {
                            <MudProgressCircular Class="ms-n1 me-2" Size="Size.Small" Indeterminate="true" Color="Color.Inherit" />
                            <span>Signing In...</span>
                        }
                        else
                        {
                            <span>Sign In</span>
                        }
                    </MudButton>
                </MudForm>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2">Need an account?</MudText>
                <MudForm @ref="signupForm" @bind-IsValid="signupValid">
                    <MudTextField @bind-Value="signupFullName"
                                  Label="Full Name (Optional)"
                                  Variant="Variant.Outlined"
                                  Class="mb-3" />

                    <MudTextField @bind-Value="signupEmail"
                                  Label="Username *"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Username is required"
                                  Class="mb-3" />

                    <MudSelect @bind-Value="signupPosition"
                               Label="Position *"
                               Variant="Variant.Outlined"
                               Required="true"
                               RequiredError="Please select your position"
                               Class="mb-3">
                        <MudSelectItem Value="@( "Analyst" )">Analyst</MudSelectItem>
                        <MudSelectItem Value="@( "Admin" )">Admin</MudSelectItem>
                        <MudSelectItem Value="@( "Viewer" )">Viewer</MudSelectItem>
                    </MudSelect>

                    <MudTextField @bind-Value="signupPassword"
                                  Label="Password *"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Password"
                                  Required="true"
                                  RequiredError="Password is required"
                                  Class="mb-4" />

                    <MudButton Variant="Variant.Outlined"
                               Size="Size.Medium"
                               FullWidth="true"
                               OnClick="HandleSignUp"
                               Disabled="@(!signupValid || signupProcessing)"
                               Color="Color.Primary"
                               Class="mb-2">
                        @if (signupProcessing)
                        {
                            <MudProgressCircular Class="ms-n1 me-2" Size="Size.Small" Indeterminate="true" Color="Color.Inherit" />
                            <span>Creating account...</span>
                        }
                        else
                        {
                            <span>Create account</span>
                        }
                    </MudButton>
                </MudForm>

                <MudText Align="Align.Center" Class="mt-4 copy-right">
                    All rights to this website belong to RASF.
                </MudText>
            </div>
        </div>
    </div>
</div>

@code {
    private MudForm loginForm = null!;
    private bool loginValid;
    private bool loginProcessing;
    private string loginUsername = "";
    private string loginPassword = "";
    private bool rememberMe = true;

    private MudForm signupForm = null!;
    private bool signupValid;
    private bool signupProcessing;
    private string signupFullName = "";
    private string signupEmail = "";
    private string signupPassword = "";
    private string signupPosition = "Analyst";

    protected override async Task OnInitializedAsync()
    {
        var autoLoginResult = await AuthService.CheckAutoLoginAsync();
        if (autoLoginResult.IsAuthenticated)
        {
            Snackbar.Add($"Welcome back, {autoLoginResult.Name}!", Severity.Success);
            NavManager.NavigateTo("/dashboard");
        }
    }

    private async Task HandleLogin()
    {
        await loginForm.Validate();
        if (!loginForm.IsValid) return;

        loginProcessing = true;
        StateHasChanged();

        var result = await AuthService.LoginAsync(loginUsername, loginPassword, rememberMe);

        loginProcessing = false;

        if (result.IsAuthenticated)
        {
            Snackbar.Add($"Welcome back, {result.Name}!", Severity.Success);
            NavManager.NavigateTo("/dashboard");
        }
        else
        {
            Snackbar.Add(result.Message, Severity.Error);
        }
    }

    private async Task HandleSignUp()
    {
        await signupForm.Validate();
        if (!signupForm.IsValid) return;

        signupProcessing = true;
        StateHasChanged();

        var result = await AuthService.RegisterAsync(signupEmail, signupPassword, signupFullName, signupPosition);

        signupProcessing = false;

        if (result.IsAuthenticated)
        {
            Snackbar.Add("Account created! Please sign in.", Severity.Success);
            signupFullName = string.Empty;
            signupEmail = string.Empty;
            signupPassword = string.Empty;
            signupPosition = "Analyst";
        }
        else
        {
            Snackbar.Add(result.Message, Severity.Error);
        }
    }
}
