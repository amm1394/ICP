@page "/"
@page "/login"
@using MudBlazor
@using WebUI.Services
@inject NavigationManager NavManager
@inject ISnackbar Snackbar
@inject AuthService AuthService

<PageTitle>ICP - Login</PageTitle>

<div class="login-container">
    <div class="login-wrapper">
        <!-- Left Panel - Logo -->
        <div class="login-logo-panel">
            <div class="text-center">
                <div class="login-logo-text">
                    <img src="Images/logo-RASF1.png" width="180" />
                </div>
                <div class="login-logo-subtitle">Razi Applied Science Foundation</div>
            </div>
        </div>

        <!-- Right Panel - Form -->
        <div class="login-form-panel">
            <div class="login-form-card">

                @if (showSignUp)
                {
                    <!-- Sign Up Form -->
                    <MudText Typo="Typo.h4" Align="Align.Center" Class="login-welcome-title">
                        Create Account
                    </MudText>

                    <MudForm @ref="signupForm" @bind-IsValid="signupValid">
                        <MudTextField @bind-Value="signupFullName"
                                      Label="Full Name (Optional)"
                                      Variant="Variant.Outlined"
                                      Class="mb-4" />

                        <MudTextField @bind-Value="signupEmail"
                                      Label="UserName *"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="UserName is required"
                                      Class="mb-4" />

                        <MudSelect @bind-Value="signupPosition"
                                   Label="Position *"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Please select your position"
                                   Class="mb-4">
                            <MudSelectItem Value="@("Lab Manager")">Lab Manager</MudSelectItem>
                            <MudSelectItem Value="@("Senior Analyst")">Senior Analyst</MudSelectItem>
                            <MudSelectItem Value="@("Chemist")">Chemist</MudSelectItem>
                            <MudSelectItem Value="@("QA/QC Engineer")">QA/QC Engineer</MudSelectItem>
                            <MudSelectItem Value="@("Researcher")">Researcher</MudSelectItem>
                            <MudSelectItem Value="@("Technician")">Technician</MudSelectItem>
                            <MudSelectItem Value="@("Student")">Student</MudSelectItem>
                            <MudSelectItem Value="@("Other")">Other</MudSelectItem>
                        </MudSelect>

                        <MudTextField @bind-Value="signupPassword"
                                      Label="Password *"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Password"
                                      Required="true"
                                      RequiredError="Password is required"
                                      Class="mb-6" />

                        <MudButton Variant="Variant.Filled"
                                   Size="Size.Large"
                                   FullWidth="true"
                                   OnClick="HandleSignUp"
                                   Disabled="@(! signupValid || signupProcessing)"
                                   Class="login-btn mb-4">
                            @if (signupProcessing)
                            {
                                <MudProgressCircular Class="ms-n1 me-2" Size="Size.Small" Indeterminate="true" Color="Color.Inherit" />
                                <span>Creating... </span>
                            }
                            else
                            {
                                <span>Create Account</span>
                            }
                        </MudButton>

                        <MudText Align="Align.Center" Class="mt-4">
                            Already have an account?
                            <span class="login-link" @onclick="() => showSignUp = false">Sign In</span>
                        </MudText>
                    </MudForm>
                }
                else
                {
                    <!-- Sign In Form -->
                    <MudText Typo="Typo.h4" Align="Align.Center" Class="login-welcome-title">
                        Sign in to your account
                    </MudText>

                    <MudForm @ref="loginForm" @bind-IsValid="loginValid">
                        <MudTextField @bind-Value="loginEmail"
                                      Label="UserName"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      Immediate="true"
                                      RequiredError="UserName is required"
                                      Validation="@(new Func<string, string?>(ValidateUsername))"
                                      Class="mb-4" />

                        <MudTextField @bind-Value="loginPassword"
                                      Label="Password"
                                      Variant="Variant.Outlined"
                                      InputType="@loginPasswordInputType"
                                      Required="true"
                                      Immediate="true"
                                      RequiredError="Password is required"
                                      Validation="@(new Func<string, string?>(ValidatePassword))"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@loginPasswordIcon"
                                      OnAdornmentClick="() => loginPasswordVisible = !loginPasswordVisible"
                                      AdornmentAriaLabel="Show Password"
                                      Class="mb-4" />

                        <MudCheckBox @bind-Value="rememberMe"
                                     Label="Remember Me"
                                   
                                     Size="Size.Small"
                                     Class="mb-4" />

                     
                        <MudButton Variant="Variant.Filled"
                                   Size="Size.Large"
                                   FullWidth="true"
                                   OnClick="HandleLogin"
                                   Disabled="@(!IsLoginFormValid() || loginProcessing)"
                                   Class="login-btn mb-3">
                            @if (loginProcessing)
                            {
                                <MudProgressCircular Class="ms-n1 me-2" Size="Size.Small" Indeterminate="true" Color="Color.Inherit" />
                                <span>Signing In...</span>
                            }
                            else
                            {
                                <span>Sign In</span>
                            }
                        </MudButton>



                        <MudText Align="Align.Center" Class="mt-4 copy-right">
                            All rights to this website belong to RASF.
                        </MudText>
                    </MudForm>
                }
            </div>
        </div>
    </div>
</div>

@code {
    // Sign In fields
    private MudForm loginForm = null!;
    private bool loginValid;
    private bool loginProcessing = false;
    private string loginEmail = "";
    private string loginPassword = "";
    private bool rememberMe = true;

    // Sign Up fields
    private MudForm signupForm = null!;
    private bool signupValid;
    private bool signupProcessing = false;
    private string signupFullName = "";
    private string signupEmail = "";
    private string signupPassword = "";
    private string signupPosition = "";

    // Toggle between Sign In / Sign Up
    private bool showSignUp = false;

    protected override async Task OnInitializedAsync()
    {
        var autoLoginResult = await AuthService.CheckAutoLoginAsync();
        if (autoLoginResult.IsAuthenticated)
        {
            Snackbar.Add($"Welcome back, {autoLoginResult.Name}!", Severity.Success);
            NavManager.NavigateTo("/dashboard");
        }
    }

    private async Task HandleLogin()
    {
        await loginForm.Validate();
        if (!loginForm.IsValid) return;

        loginProcessing = true;
        StateHasChanged();

        var result = await AuthService.LoginAsync(loginEmail, loginPassword, rememberMe);

        loginProcessing = false;

        if (result.IsAuthenticated)
        {
            Snackbar.Add($"Welcome back, {result.Name}!", Severity.Success);
            NavManager.NavigateTo("/dashboard");
        }
        else
        {
            Snackbar.Add(result.Message, Severity.Error);
        }
    }

    private async Task HandleSignUp()
    {
        await signupForm.Validate();
        if (!signupForm.IsValid) return;

        if (string.IsNullOrEmpty(signupPosition))
        {
            Snackbar.Add("Please select your position", Severity.Warning);
            return;
        }

        signupProcessing = true;
        StateHasChanged();

        var result = await AuthService.RegisterAsync(signupEmail, signupPassword, signupFullName, signupPosition);

        signupProcessing = false;

        if (result.IsAuthenticated)
        {
            Snackbar.Add("Account created!  Please sign in.", Severity.Success);
            signupFullName = "";
            signupEmail = "";
            signupPassword = "";
            signupPosition = "";
            showSignUp = false;
        }
        else
        {
            Snackbar.Add(result.Message, Severity.Error);
        }
    }

    // Password visibility toggle
    private bool loginPasswordVisible = false;
    private InputType loginPasswordInputType => loginPasswordVisible ? InputType.Text : InputType.Password;
    private string loginPasswordIcon => loginPasswordVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;

    private bool IsLoginFormValid()
    {
        return !string.IsNullOrWhiteSpace(loginEmail) &&
               loginEmail.Length >= 4 &&
               !ContainsPersian(loginEmail) &&
               !string.IsNullOrWhiteSpace(loginPassword) &&
               loginPassword.Length >= 6 &&
               !ContainsPersian(loginPassword);
    }

    // چک کردن متن فارسی
    private bool ContainsPersian(string text)
    {
        if (string.IsNullOrEmpty(text)) return false;
        // رنج کاراکترهای فارسی/عربی
        return text.Any(c => c >= 0x0600 && c <= 0x06FF);
    }

    // Validation برای Username
    private string? ValidateUsername(string value)
    {
        if (ContainsPersian(value))
            return "Please use English characters only";
        if(!string.IsNullOrEmpty(value) && value.Length < 4)
        {
            return "Username must be at least 4 characters";
        }
        return null;
    }

    // Validation برای Password
    private string? ValidatePassword(string value)
    {
        if (ContainsPersian(value))
            return "Please use English characters only";
        if (!string.IsNullOrEmpty(value) && value.Length < 6)
            return "Password must be at least 6 characters";
        return null;
    }
}