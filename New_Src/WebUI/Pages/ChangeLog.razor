@page "/changelog"
@using WebUI.Services
@inject ProjectService ProjectService
@inject ISnackbar Snackbar

<PageTitle>ICP - Change Log</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Elevation="0" Class="pa-4 mb-4">
        <div class="d-flex justify-space-between align-center">
            <div>
                <MudText Typo="Typo.h4" Class="fw-bold">Change Log</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    Track all changes made to project data
                </MudText>
            </div>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="LoadChangeLogs"
                       Disabled="_isLoading">
                Refresh
            </MudButton>
        </div>
    </MudPaper>

    @if (_projectId == null)
    {
        <MudAlert Severity="Severity.Warning">
            Please select a project first.
        </MudAlert>
    }
    else
    {
        @* Filters *@
        <MudPaper Elevation="2" Class="pa-4 mb-4">
            <MudGrid>
                <MudItem xs="12" md="3">
                    <MudSelect T="string"
                               Label="Change Type"
                               @bind-Value="_filterType"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        <MudSelectItem Value="@("Import")">Import</MudSelectItem>
                        <MudSelectItem Value="@("WeightCorrection")">Weight Correction</MudSelectItem>
                        <MudSelectItem Value="@("VolumeCorrection")">Volume Correction</MudSelectItem>
                        <MudSelectItem Value="@("DriftCorrection")">Drift Correction</MudSelectItem>
                        <MudSelectItem Value="@("CrmCalibration")">CRM Calibration</MudSelectItem>
                        <MudSelectItem Value="@("Delete")">Delete</MudSelectItem>
                        <MudSelectItem Value="@("Export")">Export</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudDatePicker Label="From Date"
                                   @bind-Date="_filterFromDate"
                                   Variant="Variant.Outlined"
                                   Clearable="true" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudDatePicker Label="To Date"
                                   @bind-Date="_filterToDate"
                                   Variant="Variant.Outlined"
                                   Clearable="true" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="_filterUser"
                                  Label="User"
                                  Variant="Variant.Outlined"
                                  Clearable="true" />
                </MudItem>
            </MudGrid>
        </MudPaper>

        @* Timeline *@
        <MudPaper Elevation="2" Class="pa-4">
            @if (_isLoading)
            {
                <div class="d-flex justify-center align-center" style="min-height: 300px;">
                    <MudProgressCircular Indeterminate="true" Size="Size.Large" />
                </div>
            }
            else if (_changeLogs.Count == 0)
            {
                <MudAlert Severity="Severity.Info">
                    No change logs found for this project.
                </MudAlert>
            }
            else
            {
                <MudTimeline TimelinePosition="TimelinePosition.Start">
                    @foreach (var log in _filteredLogs)
                    {
                        <MudTimelineItem Color="@GetChangeColor(log.ChangeType)" Size="Size.Medium">
                            <ItemOpposite>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                    @log.Timestamp.ToString("yyyy-MM-dd HH:mm")
                                </MudText>
                            </ItemOpposite>
                            <ItemContent>
                                <MudCard Elevation="1">
                                    <MudCardHeader>
                                        <CardHeaderAvatar>
                                            <MudAvatar Color="@GetChangeColor(log.ChangeType)" Size="Size.Small">
                                                <MudIcon Icon="@GetChangeIcon(log.ChangeType)" Size="Size.Small" />
                                            </MudAvatar>
                                        </CardHeaderAvatar>
                                        <CardHeaderContent>
                                            <MudText Typo="Typo.body1" Class="fw-medium">@log.ChangeType</MudText>
                                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                                by @log.UserName
                                            </MudText>
                                        </CardHeaderContent>
                                        <CardHeaderActions>
                                            <MudIconButton Icon="@Icons.Material.Filled.ExpandMore"
                                                           Size="Size.Small"
                                                           OnClick="@(() => ToggleDetails(log))" />
                                        </CardHeaderActions>
                                    </MudCardHeader>
                                    @if (log.ShowDetails)
                                    {
                                        <MudCardContent>
                                            <MudText Typo="Typo.body2">@log.Description</MudText>
                                            @if (log.AffectedRows > 0)
                                            {
                                                <MudText Typo="Typo.caption" Class="mt-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.TableRows" Size="Size.Small" Class="me-1" />
                                                    Affected Rows: @log.AffectedRows
                                                </MudText>
                                            }
                                            @if (!string.IsNullOrEmpty(log.BeforeValue))
                                            {
                                                <MudDivider Class="my-2" />
                                                <div class="d-flex gap-4">
                                                    <div>
                                                        <MudText Typo="Typo.caption">Before</MudText>
                                                        <MudText Typo="Typo.body2" Class="mud-text-secondary">@log.BeforeValue</MudText>
                                                    </div>
                                                    <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Class="mt-2" />
                                                    <div>
                                                        <MudText Typo="Typo.caption">After</MudText>
                                                        <MudText Typo="Typo.body2">@log.AfterValue</MudText>
                                                    </div>
                                                </div>
                                            }
                                        </MudCardContent>
                                    }
                                </MudCard>
                            </ItemContent>
                        </MudTimelineItem>
                    }
                </MudTimeline>

                @* Pagination *@
                <div class="d-flex justify-center mt-4">
                    <MudPagination Count="@_totalPages"
                                   @bind-Selected="_currentPage"
                                   Color="Color.Primary"
                                   ShowFirstButton="true"
                                   ShowLastButton="true" />
                </div>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    [SupplyParameterFromQuery]
    public Guid? projectId { get; set; }

    private Guid? _projectId;
    private List<ChangeLogEntry> _changeLogs = new();
    private List<ChangeLogEntry> _filteredLogs => ApplyFilters();
    private bool _isLoading = false;
    private string? _filterType;
    private DateTime? _filterFromDate;
    private DateTime? _filterToDate;
    private string? _filterUser;
    private int _currentPage = 1;
    private int _pageSize = 20;
    private int _totalPages => (int)Math.Ceiling((double)_changeLogs.Count / _pageSize);

    protected override async Task OnInitializedAsync()
    {
        _projectId = projectId ?? ProjectService.CurrentProjectId;
        if (_projectId.HasValue)
        {
            await LoadChangeLogs();
        }
    }

    private async Task LoadChangeLogs()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            // Simulate loading - in real app this would call API
            await Task.Delay(500);

            _changeLogs = new List<ChangeLogEntry>
            {
                new ChangeLogEntry
                {
                    Id = Guid.NewGuid(),
                    ChangeType = "Import",
                    Description = "Imported data from Excel file: Sample_Data_2024.xlsx",
                    UserName = "admin",
                    Timestamp = DateTime.Now.AddHours(-2),
                    AffectedRows = 250
                },
                new ChangeLogEntry
                {
                    Id = Guid.NewGuid(),
                    ChangeType = "WeightCorrection",
                    Description = "Applied weight correction to 15 samples",
                    UserName = "admin",
                    Timestamp = DateTime.Now.AddHours(-1),
                    AffectedRows = 15,
                    BeforeValue = "0.2500g",
                    AfterValue = "0.2510g"
                },
                new ChangeLogEntry
                {
                    Id = Guid.NewGuid(),
                    ChangeType = "DriftCorrection",
                    Description = "Applied linear drift correction (3 segments detected)",
                    UserName = "admin",
                    Timestamp = DateTime.Now.AddMinutes(-30),
                    AffectedRows = 200
                },
                new ChangeLogEntry
                {
                    Id = Guid.NewGuid(),
                    ChangeType = "CrmCalibration",
                    Description = "Optimized Blank & Scale for 10 elements",
                    UserName = "admin",
                    Timestamp = DateTime.Now.AddMinutes(-15),
                    AffectedRows = 50
                },
                new ChangeLogEntry
                {
                    Id = Guid.NewGuid(),
                    ChangeType = "Export",
                    Description = "Exported final results to Excel",
                    UserName = "admin",
                    Timestamp = DateTime.Now.AddMinutes(-5),
                    AffectedRows = 250
                }
            };
        }
        finally
        {
            _isLoading = false;
        }
    }

    private List<ChangeLogEntry> ApplyFilters()
    {
        var filtered = _changeLogs.AsEnumerable();

        if (!string.IsNullOrEmpty(_filterType))
        {
            filtered = filtered.Where(l => l.ChangeType == _filterType);
        }

        if (_filterFromDate.HasValue)
        {
            filtered = filtered.Where(l => l.Timestamp >= _filterFromDate.Value);
        }

        if (_filterToDate.HasValue)
        {
            filtered = filtered.Where(l => l.Timestamp <= _filterToDate.Value.AddDays(1));
        }

        if (!string.IsNullOrEmpty(_filterUser))
        {
            filtered = filtered.Where(l => l.UserName.Contains(_filterUser, StringComparison.OrdinalIgnoreCase));
        }

        return filtered
            .OrderByDescending(l => l.Timestamp)
            .Skip((_currentPage - 1) * _pageSize)
            .Take(_pageSize)
            .ToList();
    }

    private void ToggleDetails(ChangeLogEntry log)
    {
        log.ShowDetails = !log.ShowDetails;
    }

    private Color GetChangeColor(string changeType) => changeType switch
    {
        "Import" => Color.Primary,
        "WeightCorrection" => Color.Warning,
        "VolumeCorrection" => Color.Warning,
        "DriftCorrection" => Color.Info,
        "CrmCalibration" => Color.Success,
        "Delete" => Color.Error,
        "Export" => Color.Secondary,
        _ => Color.Default
    };

    private string GetChangeIcon(string changeType) => changeType switch
    {
        "Import" => Icons.Material.Filled.CloudUpload,
        "WeightCorrection" => Icons.Material.Filled.FitnessCenter,
        "VolumeCorrection" => Icons.Material.Filled.Water,
        "DriftCorrection" => Icons.Material.Filled.TrendingUp,
        "CrmCalibration" => Icons.Material.Filled.Verified,
        "Delete" => Icons.Material.Filled.Delete,
        "Export" => Icons.Material.Filled.FileDownload,
        _ => Icons.Material.Filled.Edit
    };

    public class ChangeLogEntry
    {
        public Guid Id { get; set; }
        public string ChangeType { get; set; } = "";
        public string Description { get; set; } = "";
        public string UserName { get; set; } = "";
        public DateTime Timestamp { get; set; }
        public int AffectedRows { get; set; }
        public string? BeforeValue { get; set; }
        public string? AfterValue { get; set; }
        public bool ShowDetails { get; set; }
    }
}
