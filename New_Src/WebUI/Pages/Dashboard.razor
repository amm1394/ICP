@page "/dashboard"
@using WebUI.Services
@inject AuthService AuthService
@inject ProjectService ProjectService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<PageTitle>ICP - Dashboard</PageTitle>

@{
    var user = AuthService.GetCurrentUser();
    var userName = user?.Name ?? "User";
    var userPosition = user?.Position ?? "User";
}

<!-- Welcome Header -->
<div class="d-flex justify-space-between align-center mb-4">
    <div>
        <MudText Typo="Typo.h4" Class="fw-bold">
            👋 Welcome back, @userName!
        </MudText>
        <MudText Typo="Typo.body2" Class="mud-text-secondary">
            @userPosition | @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
        </MudText>
    </div>
</div>

<!-- Stats Cards -->
<MudGrid Class="mb-4">
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <MudText Typo="Typo.h4" Color="Color.Primary" Class="fw-bold">@_totalProjects</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">Total Projects</MudText>
                </div>
                <MudAvatar Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.Folder" />
                </MudAvatar>
            </div>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <MudText Typo="Typo.h4" Color="Color.Success" Class="fw-bold">@_samplesAnalyzed</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">Samples Analyzed</MudText>
                </div>
                <MudAvatar Color="Color.Success" Variant="Variant.Outlined" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.Science" />
                </MudAvatar>
            </div>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <MudText Typo="Typo.h4" Color="Color.Warning" Class="fw-bold">@_crmStandards</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">CRM Standards</MudText>
                </div>
                <MudAvatar Color="Color.Warning" Variant="Variant.Outlined" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" />
                </MudAvatar>
            </div>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <MudText Typo="Typo.h4" Color="Color.Info" Class="fw-bold">@_passRate%</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">Pass Rate</MudText>
                </div>
                <MudAvatar Color="Color.Info" Variant="Variant.Outlined" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" />
                </MudAvatar>
            </div>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudGrid>
    <!-- Quick Actions -->
    <MudItem xs="12" md="8">
        <MudPaper Elevation="2" Class="pa-4">
            <div class="d-flex align-center mb-4">
                <MudIcon Icon="@Icons.Material.Filled.FlashOn" Class="me-2" />
                <MudText Typo="Typo.h6">Quick Actions</MudText>
            </div>
            <MudGrid>
                <MudItem xs="6" sm="4">
                    <MudButton Variant="Variant.Outlined" 
                               FullWidth="true" 
                               Class="pa-4 d-flex flex-column"
                               Style="height: 100px;"
                               OnClick="@(() => NavManager.NavigateTo("/import"))">
                        <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Color="Color.Primary" Size="Size.Large" />
                        <MudText Typo="Typo.body2" Class="mt-2">Import Data</MudText>
                    </MudButton>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudButton Variant="Variant.Outlined" 
                               FullWidth="true" 
                               Class="pa-4 d-flex flex-column"
                               Style="height: 100px;"
                               OnClick="@(() => NavManager.NavigateTo("/projects"))">
                        <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Secondary" Size="Size.Large" />
                        <MudText Typo="Typo.body2" Class="mt-2">Projects</MudText>
                    </MudButton>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudButton Variant="Variant.Outlined" 
                               FullWidth="true" 
                               Class="pa-4 d-flex flex-column"
                               Style="height: 100px;"
                               OnClick="@(() => NavManager.NavigateTo("/pivot"))">
                        <MudIcon Icon="@Icons.Material.Filled.TableChart" Color="Color.Tertiary" Size="Size.Large" />
                        <MudText Typo="Typo.body2" Class="mt-2">Pivot Table</MudText>
                    </MudButton>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudButton Variant="Variant.Outlined" 
                               FullWidth="true" 
                               Class="pa-4 d-flex flex-column"
                               Style="height: 100px;"
                               OnClick="@(() => NavManager.NavigateTo("/process/weight"))">
                        <MudIcon Icon="@Icons.Material.Filled.Engineering" Color="Color.Warning" Size="Size.Large" />
                        <MudText Typo="Typo.body2" Class="mt-2">Process</MudText>
                    </MudButton>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudButton Variant="Variant.Outlined" 
                               FullWidth="true" 
                               Class="pa-4 d-flex flex-column"
                               Style="height: 100px;"
                               OnClick="@(() => NavManager.NavigateTo("/crm"))">
                        <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Color="Color.Success" Size="Size.Large" />
                        <MudText Typo="Typo.body2" Class="mt-2">CRM Database</MudText>
                    </MudButton>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudButton Variant="Variant.Outlined" 
                               FullWidth="true" 
                               Class="pa-4 d-flex flex-column"
                               Style="height: 100px;"
                               OnClick="@(() => NavManager.NavigateTo("/report"))">
                        <MudIcon Icon="@Icons.Material.Filled.Assessment" Color="Color.Info" Size="Size.Large" />
                        <MudText Typo="Typo.body2" Class="mt-2">Reports</MudText>
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    <!-- Recent Projects -->
    <MudItem xs="12" md="4">
        <MudPaper Elevation="2" Class="pa-4" Style="height: 100%;">
            <div class="d-flex align-center mb-4">
                <MudIcon Icon="@Icons.Material.Filled.History" Class="me-2" />
                <MudText Typo="Typo.h6">Recent Projects</MudText>
            </div>
            @if (_recentProjects.Count == 0)
            {
                <MudText Typo="Typo.body2" Class="mud-text-secondary">No recent projects</MudText>
            }
            else
            {
                <MudList T="string" Dense="true">
                    @foreach (var project in _recentProjects.Take(5))
                    {
                        <MudListItem Icon="@Icons.Material.Filled.FolderOpen" 
                                     OnClick="@(() => NavManager.NavigateTo($"/pivot?projectId={project.Id}"))">
                            <MudText Typo="Typo.body2">@project.Name</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">@project.Date.ToString("MMM dd, yyyy")</MudText>
                        </MudListItem>
                    }
                </MudList>
            }
            <MudButton Variant="Variant.Text" 
                       Color="Color.Primary" 
                       FullWidth="true" 
                       Class="mt-2"
                       OnClick="@(() => NavManager.NavigateTo("/projects"))">
                VIEW ALL PROJECTS
            </MudButton>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private int _totalProjects = 0;
    private int _samplesAnalyzed = 0;
    private int _crmStandards = 25;
    private int _passRate = 92;
    private List<RecentProject> _recentProjects = new();

    protected override async Task OnInitializedAsync()
    {
        var user = AuthService.GetCurrentUser();
        if (user == null || !user.IsAuthenticated)
        {
            NavManager.NavigateTo("/login");
            return;
        }

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            var result = await ProjectService.GetProjectsAsync();
            if (result.Succeeded && result.Data != null)
            {
                _totalProjects = result.Data.Count;
                _recentProjects = result.Data
                    .OrderByDescending(p => p.CreatedAt)
                    .Take(5)
                    .Select(p => new RecentProject(p.ResultProjectId ?? Guid.Empty, p.ProjectName ?? "Untitled", p.CreatedAt))
                    .ToList();
            }
        }
        catch
        {
            // Silently fail - dashboard will show zeros
        }
    }

    private record RecentProject(Guid Id, string Name, DateTime Date);
}
