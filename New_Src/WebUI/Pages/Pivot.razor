@page "/pivot"
@using WebUI.Services
@inject ProjectService ProjectService
@inject PivotService PivotService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<PageTitle>ICP - Pivot Table</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    @* Header *@
    <MudPaper Elevation="0" Class="pa-4 mb-4">
        <div class="d-flex justify-space-between align-center flex-wrap gap-4">
            <div>
                <MudText Typo="Typo.h4" Class="fw-bold">Pivot Table</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    @if (_projectName != null)
                    {
                        <span>Project: <strong>@_projectName</strong></span>
                    }
                    else
                    {
                        <span>Select a project to view data</span>
                    }
                </MudText>
            </div>
            <div class="d-flex gap-2">
                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.FolderOpen"
                           OnClick="SelectProject">
                    Change Project
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Download"
                           OnClick="ExportData"
                           Disabled="@(_pivotData == null)">
                    Export
                </MudButton>
            </div>
        </div>
    </MudPaper>

    @if (_projectId == null)
    {
        <MudPaper Elevation="2" Class="pa-8 d-flex flex-column align-center justify-center" Style="min-height: 400px;">
            <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Large" Color="Color.Primary" Class="mb-4" Style="font-size: 64px; opacity: 0.5;" />
            <MudText Typo="Typo.h5" Class="mb-2">No Project Selected</MudText>
            <MudText Typo="Typo.body1" Class="mud-text-secondary mb-4">Please select a project to view pivot table data</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.FolderOpen" Href="/projects">
                Select Project
            </MudButton>
        </MudPaper>
    }
    else
    {
        @* Filters Panel - Only show when not initial loading *@
        @if (!_isLoading || _pivotData != null)
        {
            <MudExpansionPanels Class="mb-4">
                <MudExpansionPanel Text="Filters & Options" Expanded="true">
                    <MudGrid>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="_searchText"
                                          Label="Search"
                                          Placeholder="Search in data..."
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          Immediate="true"
                                          DebounceInterval="500"
                                          Disabled="_isLoading"
                                          OnDebounceIntervalElapsed="LoadData" />
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudSelect T="string" 
                                       Label="@($"Elements ({_allElements.Count})")" 
                                       MultiSelection="true"
                                       @bind-SelectedValues="_selectedElements"
                                       Variant="Variant.Outlined"
                                       Dense="true"
                                       Disabled="_isLoading"
                                       AnchorOrigin="Origin.BottomCenter"
                                       TransformOrigin="Origin.TopCenter">
                                @foreach (var element in _allElements)
                                {
                                    <MudSelectItem Value="@element">@element</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6" md="2">
                            <MudNumericField @bind-Value="_decimalPlaces"
                                             Label="Decimals"
                                             Variant="Variant.Outlined"
                                             Disabled="_isLoading"
                                             Min="0"
                                             Max="6" />
                        </MudItem>
                        <MudItem xs="6" md="2">
                            <MudCheckBox @bind-Value="_useOxide"
                                         Label="Use Oxide"
                                         Disabled="_isLoading"
                                         Color="Color.Primary" />
                        </MudItem>
                        <MudItem xs="12" md="1">
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       FullWidth="true"
                                       OnClick="LoadData"
                                       Disabled="_isLoading">
                                Apply
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }

        @* Data Table *@
        <MudPaper Elevation="2" Class="pa-0">
            @if (_isLoading)
            {
                <div class="d-flex flex-column justify-center align-center py-8" style="min-height: 300px;">
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="mb-4" />
                    <MudText Typo="Typo.body1" Class="mud-text-secondary">Loading data...</MudText>
                </div>
            }
            else if (_pivotData == null || !_pivotData.Rows.Any())
            {
                <div class="d-flex flex-column justify-center align-center py-8" style="min-height: 300px;">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Default" Class="mb-4" Style="font-size: 48px; opacity: 0.3;" />
                    <MudText Typo="Typo.h6" Class="mb-2">No Data Found</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">Try adjusting your filters or select different elements</MudText>
                </div>
            }
            else
            {
                <div style="overflow-x: auto;">
                    <MudTable Items="@_pivotData.Rows"
                              Hover="true"
                              Striped="true"
                              Dense="true"
                              FixedHeader="true"
                              Height="calc(100vh - 400px)"
                              Loading="_isLoading">
                        <HeaderContent>
                            <MudTh Style="position: sticky; left: 0; background: var(--mud-palette-surface); z-index: 1;">
                                <MudTableSortLabel SortBy="new Func<AdvancedPivotRowDto, object>(x => x.SolutionLabel)">
                                    Solution Label
                                </MudTableSortLabel>
                            </MudTh>
                            @if (_hasRepeats)
                            {
                                <MudTh>Set</MudTh>
                            }
                            @foreach (var col in _displayColumns)
                            {
                                <MudTh>
                                    <div class="d-flex flex-column">
                                        <span>@col</span>
                                        @if (_pivotData.Metadata?.ColumnStats.TryGetValue(col, out var stats) == true)
                                        {
                                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                                Î¼=@(stats.Mean?.ToString($"F{_decimalPlaces}") ?? "-")
                                            </MudText>
                                        }
                                    </div>
                                </MudTh>
                            }
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd Style="position: sticky; left: 0; background: var(--mud-palette-surface); z-index: 1; font-weight: 500;">
                                @context.SolutionLabel
                            </MudTd>
                            @if (_hasRepeats)
                            {
                                <MudTd>
                                    @if (context.SetSize > 1)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@(context.SetIndex + 1)/@context.SetSize</MudChip>
                                    }
                                </MudTd>
                            }
                            @foreach (var col in _displayColumns)
                            {
                                <MudTd Style="text-align: right;">
                                    @if (context.Values.TryGetValue(col, out var val) && val.HasValue)
                                    {
                                        @val.Value.ToString($"F{_decimalPlaces}")
                                    }
                                    else
                                    {
                                        <span class="mud-text-disabled">-</span>
                                    }
                                </MudTd>
                            }
                        </RowTemplate>
                        <PagerContent>
                            <div class="d-flex justify-space-between align-center pa-4">
                                <MudText Typo="Typo.body2">
                                    Total: @_pivotData.TotalCount rows | Showing: @_pivotData.Rows.Count
                                </MudText>
                                <MudPagination Count="@_totalPages" 
                                               Selected="_currentPage"
                                               SelectedChanged="OnPageChanged"
                                               ShowFirstButton="true"
                                               ShowLastButton="true" />
                            </div>
                        </PagerContent>
                    </MudTable>
                </div>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    [SupplyParameterFromQuery]
    public Guid? projectId { get; set; }

    private Guid? _projectId;
    private string? _projectName;
    private AdvancedPivotResultDto? _pivotData;
    private List<string> _allElements = new();
    private List<string> _displayColumns = new();
    private IEnumerable<string> _selectedElements = new HashSet<string>();
    private string _searchText = "";
    private int _decimalPlaces = 2;
    private bool _useOxide = false;
    private bool _useInt = false;  // Use Int column instead of Corr Con
    private bool _mergeRepeats = false;  // Merge repeated elements
    private bool _isLoading = true;  // Start with loading state
    private int _currentPage = 1;
    private int _pageSize = 100;
    private int _totalPages = 1;
    private bool _hasRepeats = false;  // Track if data has repeated elements

    protected override async Task OnInitializedAsync()
    {
        _projectId = projectId ?? ProjectService.CurrentProjectId;
        
        if (_projectId.HasValue)
        {
            _isLoading = true;
            StateHasChanged();

            var projectResult = await ProjectService.GetProjectAsync(_projectId.Value);
            if (projectResult.Succeeded && projectResult.Data != null)
            {
                _projectName = projectResult.Data.ProjectName;
            }

            await LoadElements();
            await LoadData();
        }
        else
        {
            _isLoading = false;
        }
    }

    private async Task LoadElements()
    {
        if (_projectId == null) return;

        var result = await PivotService.GetElementsAsync(_projectId.Value);
        if (result.Succeeded && result.Data != null)
        {
            _allElements = result.Data;
        }
    }

    private async Task LoadData()
    {
        if (_projectId == null) return;

        _isLoading = true;
        StateHasChanged();

        // Use AdvancedPivotRequest for Python-compatible duplicate handling
        var request = new AdvancedPivotRequest(
            ProjectId: _projectId.Value,
            SearchText: string.IsNullOrWhiteSpace(_searchText) ? null : _searchText,
            SelectedElements: _selectedElements.Any() ? _selectedElements.ToList() : null,
            UseOxide: _useOxide,
            UseInt: _useInt,
            DecimalPlaces: _decimalPlaces,
            Page: _currentPage,
            PageSize: _pageSize,
            MergeRepeats: _mergeRepeats
        );

        var result = await PivotService.GetAdvancedPivotTableAsync(request);

        if (result.Succeeded && result.Data != null)
        {
            _pivotData = result.Data;
            _displayColumns = _pivotData.Columns;
            _totalPages = (int)Math.Ceiling(_pivotData.TotalCount / (double)_pageSize);
            _hasRepeats = _pivotData.Metadata?.HasRepeats ?? false;

            if (_pivotData.Metadata?.AllElements != null && !_allElements.Any())
            {
                _allElements = _pivotData.Metadata.AllElements;
            }
        }
        else
        {
            Snackbar.Add(result.Message ?? "Failed to load data", Severity.Error);
        }

        _isLoading = false;
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadData();
    }

    private void SelectProject()
    {
        NavManager.NavigateTo("/projects");
    }

    private async Task ExportData()
    {
        if (_projectId == null || _pivotData == null) return;

        var request = new PivotRequest
        {
            ProjectId = _projectId.Value,
            UseOxide = _useOxide,
            DecimalPlaces = _decimalPlaces
        };

        var result = await PivotService.ExportToCsvAsync(request);
        if (result.Succeeded && result.Data != null)
        {
            var fileName = $"{_projectName ?? "export"}_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            await DownloadFile(result.Data, fileName, "text/csv");
            Snackbar.Add("Data exported successfully", Severity.Success);
        }
        else
        {
            Snackbar.Add(result.Message ?? "Export failed", Severity.Error);
        }
    }

    private async Task DownloadFile(byte[] data, string fileName, string contentType)
    {
        var base64 = Convert.ToBase64String(data);
        await JS.InvokeVoidAsync("downloadFile", fileName, contentType, base64);
    }
}
