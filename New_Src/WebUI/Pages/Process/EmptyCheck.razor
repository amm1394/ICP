@page "/process/empty"
@using WebUI.Services
@inject ProjectService ProjectService
@inject CorrectionService CorrectionService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>ICP - Empty Check</PageTitle>
<NavigationLock OnBeforeInternalNavigation="OnBeforeNavigation" ConfirmExternalNavigation="_isLoading" />
@* Loading Overlay *@
@if (_isLoading)
{
    <div class="loading-overlay">
        <MudPaper Elevation="4" Class="pa-6 d-flex flex-column align-center">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Class="mt-4">Processing...</MudText>

        </MudPaper>
    </div>
}

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Elevation="0" Class="pa-4 mb-4 custom-card-all">
        <div class="d-flex justify-space-between align-center">
            <div>
                <MudText Typo="Typo.h4" Class="fw-bold">Empty Check</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    @if (!string.IsNullOrEmpty(_projectName))
                    {
                        <span>Project: <strong>@_projectName</strong> | </span>
                    }
                    Detect empty or outlier samples where most elements are below average
                </MudText>
            </div>
            <ProcessNav CurrentStep="empty" />
        </div>
    </MudPaper>

    @if (_projectId == null)
    {
        <MudAlert Severity="Severity.Warning">
            Please select a project first. <MudLink Href="/projects">Go to Projects</MudLink>
        </MudAlert>
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudPaper Elevation="0" Class="pa-4 custom-card-all">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Settings" Class="me-2" />
                        Settings
                    </MudText>

                    <MudSlider @bind-Value="_thresholdPercent"
                               Min="10"
                               Max="100"
                               Step="5"
                               Color="Color.Primary"
                               Class="mb-2">
                        Threshold: @_thresholdPercent%
                    </MudSlider>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary mb-4">
                        Samples with values below this % of column average will be flagged
                    </MudText>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Search"
                               OnClick="FindEmptyRows"
                               Disabled="_isLoading">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                        }
                        Find Empty Rows
                    </MudButton>
                </MudPaper>

                @if (_emptyRows != null && _emptyRows.Any())
                {
                    <MudPaper Elevation="0" Class="pa-4 mt-4 custom-card-all">
                        <MudText Typo="Typo.h6" Class="mb-2">Summary</MudText>
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex justify-space-between">
                                <MudText>Empty Rows Found:</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Error">@_totalCount</MudChip>
                            </div>
                            @if (_selectedRows.Any())
                            {
                                <div class="d-flex justify-space-between">
                                    <MudText>Selected:</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">@_selectedRows.Count</MudChip>
                                </div>
                            }
                            
                            @* Progress Bar for Delete Operation *@
                            @if (_isDeleting && _deleteProgress > 0)
                            {
                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.caption" Class="mb-1">
                                    Deleting: @_deletedCount / @_totalToDelete rows
                                </MudText>
                                <MudProgressLinear Value="@_deleteProgress" 
                                                   Color="Color.Error" 
                                                   Striped="true" 
                                                   Size="Size.Large"
                                                   Class="mb-2">
                                    <MudText Typo="Typo.caption">@_deleteProgress.ToString("F0")%</MudText>
                                </MudProgressLinear>
                            }
                            
                            <MudDivider Class="my-2" />
                            
                            @* Delete All - ÿ≠ÿ∞ŸÅ ŸáŸÖŸá *@
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Error"
                                       FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.DeleteForever"
                                       OnClick="DeleteAllRows"
                                       Disabled="@(_isDeleting || _totalCount == 0)">
                                @if (_isDeleting)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                                }
                                üóëÔ∏è DELETE ALL (@_totalCount)
                            </MudButton>

                            <MudDivider Class="my-2" />
                            
                            @* Select All - ÿßŸÜÿ™ÿÆÿßÿ® ŸáŸÖŸá *@
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.DoneAll"
                                       OnClick="SelectAllRows"
                                       Disabled="@(_totalCount == 0)">
                                Select ALL (@_totalCount)
                            </MudButton>

                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Secondary"
                                       FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Clear"
                                       OnClick="ClearSelection"
                                       Disabled="@(!_selectedRows.Any())">
                                Clear Selection
                            </MudButton>

                            <MudDivider Class="my-2" />
                            
                            @* Delete Selected - ÿ≠ÿ∞ŸÅ ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØŸá‚ÄåŸáÿß *@
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Warning"
                                       FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Delete"
                                       OnClick="DeleteSelectedRows"
                                       Disabled="@(!_selectedRows.Any() || _isDeleting)">
                                Delete Selected (@_selectedRows.Count)
                            </MudButton>
                            
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Info"
                                       FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.SelectAll"
                                       OnClick="SelectAllOnPage">
                                Select Page (@_pagedRows.Count)
                            </MudButton>
                        </div>
                    </MudPaper>
                }
            </MudItem>

            <MudItem xs="12" md="9" >
                <MudPaper Elevation="0" Class="pa-4 custom-card-all">
                    <div class="d-flex justify-space-between align-center mb-4">
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.RemoveCircleOutline" Color="Color.Warning" Class="me-2" />
                            Empty/Outlier Samples
                        </MudText>
                        @if (_emptyRows != null && _emptyRows.Any())
                        {
                            <MudText Typo="Typo.caption">
                                Showing @((_currentPage - 1) * _pageSize + 1) - @Math.Min(_currentPage * _pageSize, _totalCount) of @_totalCount
                            </MudText>
                        }
                    </div>

                    @if (_emptyRows == null)
                    {
                        <MudAlert Severity="Severity.Info">
                            Click "Find Empty Rows" to detect samples with unusually low values.
                        </MudAlert>
                    }
                    else if (!_emptyRows.Any())
                    {
                        <MudAlert Severity="Severity.Success">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="me-2" />
                            No empty or outlier samples detected!
                        </MudAlert>
                    }
                    else
                    {
                        <MudTable Items="@_pagedRows"
                                  Hover="true"
                                  Dense="true"
                                  FixedHeader="true"
                                  @* Height="200px" *@
                                  T="EmptyRowDto"
                                  OnRowClick="@((args) => { if (args.Item != null) SelectRow(args.Item); })">
                            <HeaderContent>
                                <MudTh><MudCheckBox T="bool" Value="@IsAllSelectedOnPage()" ValueChanged="@((bool val) => ToggleSelectAllOnPage(val))" /></MudTh>
                                <MudTh>Solution Label</MudTh>
                                <MudTh>Elements Below</MudTh>
                                <MudTh>Total</MudTh>
                                <MudTh>Score</MudTh>
                                <MudTh>Status</MudTh>
                                <MudTh>Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>
                                    <MudCheckBox T="bool" Value="@_selectedRows.Contains(context)" 
                                                 ValueChanged="@((bool val) => ToggleRowSelection(context, val))" />
                                </MudTd>
                                <MudTd>
                                    <MudText Class="fw-medium">@context.SolutionLabel</MudText>
                                </MudTd>
                                <MudTd>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Error">
                                        @context.ElementsBelowThreshold
                                    </MudChip>
                                </MudTd>
                                <MudTd>@context.TotalElementsChecked</MudTd>
                                <MudTd>
                                    <MudProgressLinear Value="@((double)context.OverallScore)" 
                                                       Color="@GetScoreColor(context.OverallScore)"
                                                       Size="Size.Small"
                                                       Style="width: 80px;" />
                                    <MudText Typo="Typo.caption">@context.OverallScore.ToString("F1")%</MudText>
                                </MudTd>
                                <MudTd>
                                    @if (context.OverallScore < 30)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Error">Empty</MudChip>
                                    }
                                    else if (context.OverallScore < 50)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">Low</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info">Borderline</MudChip>
                                    }
                                </MudTd>
                                <MudTd>
                                    <MudTooltip Text="Delete this row">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                       Color="Color.Error" 
                                                       Size="Size.Small"
                                                       OnClick="@(() => DeleteSingleRow(context))" />
                                    </MudTooltip>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>

                        @* Pagination *@
                        <div class="d-flex justify-center align-center mt-4 gap-4">
                            <MudSelect T="int" Value="_pageSize" ValueChanged="OnPageSizeChanged" 
                                       Label="Per Page" Variant="Variant.Outlined" Dense="true" Style="width: 100px;">
                                <MudSelectItem Value="25">25</MudSelectItem>
                                <MudSelectItem Value="50">50</MudSelectItem>
                                <MudSelectItem Value="100">100</MudSelectItem>
                                <MudSelectItem Value="200">200</MudSelectItem>
                            </MudSelect>
                            <MudPagination Count="@_totalPages" 
                                           Selected="_currentPage"
                                           SelectedChanged="OnPageChanged"
                                           ShowFirstButton="true"
                                           ShowLastButton="true"
                                           BoundaryCount="1"
                                           MiddleCount="3" />
                        </div>

                        @* Element Details *@
                        <MudExpansionPanels Class="mt-4" >
                            <MudExpansionPanel Text="Element Details" @bind-Expanded="_detailsExpanded">
                                @if (_selectedEmpty != null)
                                {
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                                        Selected: <strong>@_selectedEmpty.SolutionLabel</strong>
                                    </MudText>
                                    <MudSimpleTable Dense="true">
                                        <thead>
                                            <tr>
                                                <th>Element</th>
                                                <th>Value</th>
                                                <th>Average</th>
                                                <th>% of Avg</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var element in _selectedEmpty.PercentOfAverage.OrderBy(x => x.Value).Take(15))
                                            {
                                                <tr>
                                                    <td>@element.Key</td>
                                                    <td>@(_selectedEmpty.ElementValues.TryGetValue(element.Key, out var v) ? v?.ToString("F4") : "-")</td>
                                                    <td>@(_selectedEmpty.ElementAverages.TryGetValue(element.Key, out var a) ? a.ToString("F4") : "-")</td>
                                                    <td>
                                                        <MudText Color="@((decimal)element.Value < _thresholdPercent ? Color.Error : Color.Default)">
                                                            @element.Value.ToString("F1")%
                                                        </MudText>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </MudSimpleTable>
                                }
                                else
                                {
                                    <MudText Class="mud-text-secondary">Click on a row to see element details</MudText>
                                }
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
</style>

@code {
    [SupplyParameterFromQuery]
    public Guid? projectId { get; set; }

    private Guid? _projectId;
    private string? _projectName;
    private decimal _thresholdPercent = 70m;
    private List<EmptyRowDto>? _emptyRows;
    private List<EmptyRowDto> _pagedRows = new();
    private EmptyRowDto? _selectedEmpty;
    private HashSet<EmptyRowDto> _selectedRows = new();
    private bool _isLoading = false;
    private bool _isDeleting = false;
    private bool _detailsExpanded = true;

    // Progress tracking for delete
    private double _deleteProgress = 0;
    private int _deletedCount = 0;
    private int _totalToDelete = 0;

    // Pagination
    private int _currentPage = 1;
    private int _pageSize = 50;
    private int _totalCount = 0;
    private int _totalPages => (int)Math.Ceiling((double)_totalCount / _pageSize);

    protected override async Task OnInitializedAsync()
    {
        _projectId = projectId ?? ProjectService.CurrentProjectId;
        if (_projectId.HasValue)
        {
            var result = await ProjectService.GetProjectAsync(_projectId.Value);
            if (result.Succeeded && result.Data != null)
            {
                _projectName = result.Data.ProjectName;
            }
        }
    }

    private async Task FindEmptyRows()
    {
        if (_projectId == null) return;

        _isLoading = true;
        _selectedRows.Clear();
        StateHasChanged();

        var result = await CorrectionService.FindEmptyRowsAsync(_projectId.Value, _thresholdPercent);

        if (result.Succeeded && result.Data != null)
        {
            _emptyRows = result.Data.OrderBy(x => x.OverallScore).ToList();
            _totalCount = _emptyRows.Count;
            _currentPage = 1;
            UpdatePagedRows();

            if (_emptyRows.Any())
            {
                _selectedEmpty = _emptyRows.First();
                Snackbar.Add($"Found {_emptyRows.Count} empty/outlier samples", Severity.Warning);
            }
        }
        else
        {
            Snackbar.Add(result.Message ?? "Failed", Severity.Error);
            _emptyRows = new();
            _totalCount = 0;
        }

        _isLoading = false;
    }

    private void UpdatePagedRows()
    {
        if (_emptyRows == null) return;
        
        _pagedRows = _emptyRows
            .Skip((_currentPage - 1) * _pageSize)
            .Take(_pageSize)
            .ToList();
    }

    private void OnPageChanged(int page)
    {
        _currentPage = page;
        UpdatePagedRows();
        StateHasChanged();
    }

    private void OnPageSizeChanged(int size)
    {
        _pageSize = size;
        _currentPage = 1;
        UpdatePagedRows();
        StateHasChanged();
    }

    private void SelectRow(EmptyRowDto row)
    {
        _selectedEmpty = row;
    }

    private void ToggleRowSelection(EmptyRowDto row, bool selected)
    {
        if (selected)
            _selectedRows.Add(row);
        else
            _selectedRows.Remove(row);
    }

    private bool IsAllSelectedOnPage()
    {
        return _pagedRows.Any() && _pagedRows.All(r => _selectedRows.Contains(r));
    }

    private void ToggleSelectAllOnPage(bool selectAll)
    {
        if (selectAll)
        {
            foreach (var row in _pagedRows)
                _selectedRows.Add(row);
        }
        else
        {
            foreach (var row in _pagedRows)
                _selectedRows.Remove(row);
        }
    }

    private void SelectAllOnPage()
    {
        foreach (var row in _pagedRows)
            _selectedRows.Add(row);
    }

    private void SelectAllRows()
    {
        if (_emptyRows == null) return;
        foreach (var row in _emptyRows)
            _selectedRows.Add(row);
    }

    private void ClearSelection()
    {
        _selectedRows.Clear();
    }

    private async Task DeleteAllRows()
    {
        if (_emptyRows == null || !_emptyRows.Any() || _projectId == null) return;

        var confirm = await DialogService.ShowMessageBox(
            "‚ö†Ô∏è Delete ALL Empty Rows",
            $"Are you sure you want to delete ALL {_totalCount} empty/outlier rows?\n\nThis action CANNOT be undone!",
            yesText: "Yes, Delete All",
            cancelText: "Cancel");

        if (confirm != true) return;

        // ÿØŸàŸÖ€åŸÜ ÿ™ÿ£€å€åÿØ ÿ®ÿ±ÿß€å ÿßÿ∑ŸÖ€åŸÜÿßŸÜ
        var doubleConfirm = await DialogService.ShowMessageBox(
            "‚ö†Ô∏è Final Confirmation",
            $"This will permanently delete {_totalCount} rows. Are you absolutely sure?",
            yesText: "DELETE",
            cancelText: "Cancel");

        if (doubleConfirm != true) return;

        _isDeleting = true;
        _deleteProgress = 0;
        _deletedCount = 0;
        StateHasChanged();

        // ÿ≠ÿ∞ŸÅ ÿ®Ÿá ÿµŸàÿ±ÿ™ ÿØÿ≥ÿ™Ÿá‚Äåÿß€å (batch) ÿ®ÿ±ÿß€å ÿ¨ŸÑŸà⁄Ø€åÿ±€å ÿßÿ≤ timeout
        var allLabels = _emptyRows.Select(r => r.SolutionLabel).ToList();
        var batchSize = 500;
        _totalToDelete = allLabels.Count;
        var totalDeleted = 0;

        for (int i = 0; i < allLabels.Count; i += batchSize)
        {
            var batch = allLabels.Skip(i).Take(batchSize).ToList();
            var result = await CorrectionService.DeleteRowsAsync(_projectId.Value, batch);
            
            if (result.Succeeded)
            {
                totalDeleted += result.Data;
                _deletedCount = totalDeleted;
                _deleteProgress = (double)totalDeleted / _totalToDelete * 100;
                StateHasChanged();
                
                Snackbar.Add($"Batch {i / batchSize + 1}: Deleted {result.Data} rows ({_deleteProgress:F0}%)", Severity.Info);
            }
            else
            {
                Snackbar.Add($"Failed to delete batch: {result.Message}", Severity.Error);
                break;
            }
        }

        if (totalDeleted > 0)
        {
            Snackbar.Add($"‚úÖ Successfully deleted {totalDeleted} rows total!", Severity.Success);
            _emptyRows?.Clear();
            _selectedRows.Clear();
            _totalCount = 0;
            UpdatePagedRows();
        }

        _isDeleting = false;
        _deleteProgress = 0;
        _deletedCount = 0;
        _totalToDelete = 0;
    }

    private async Task DeleteSelectedRows()
    {
        if (!_selectedRows.Any() || _projectId == null) return;

        var confirm = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete {_selectedRows.Count} selected rows? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm != true) return;

        _isDeleting = true;
        StateHasChanged();

        var labels = _selectedRows.Select(r => r.SolutionLabel).ToList();
        var result = await CorrectionService.DeleteRowsAsync(_projectId.Value, labels);

        if (result.Succeeded)
        {
            Snackbar.Add($"Deleted {result.Data} rows successfully", Severity.Success);
            
            // Remove from local list
            foreach (var row in _selectedRows.ToList())
            {
                _emptyRows?.Remove(row);
            }
            _selectedRows.Clear();
            _totalCount = _emptyRows?.Count ?? 0;
            UpdatePagedRows();
        }
        else
        {
            Snackbar.Add(result.Message ?? "Failed to delete rows", Severity.Error);
        }

        _isDeleting = false;
    }

    private async Task DeleteSingleRow(EmptyRowDto row)
    {
        if (_projectId == null) return;

        var confirm = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete '{row.SolutionLabel}'?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm != true) return;

        var result = await CorrectionService.DeleteRowsAsync(_projectId.Value, new List<string> { row.SolutionLabel });

        if (result.Succeeded)
        {
            Snackbar.Add($"Deleted '{row.SolutionLabel}'", Severity.Success);
            _emptyRows?.Remove(row);
            _selectedRows.Remove(row);
            _totalCount = _emptyRows?.Count ?? 0;
            UpdatePagedRows();
        }
        else
        {
            Snackbar.Add(result.Message ?? "Failed to delete", Severity.Error);
        }
    }

    private Color GetScoreColor(decimal score)
    {
        if (score < 30) return Color.Error;
        if (score < 50) return Color.Warning;
        return Color.Info;
    }
    private async Task OnBeforeNavigation(LocationChangingContext context)
    {
        if (_isLoading)
        {
            context.PreventNavigation();
        }
    }

}
