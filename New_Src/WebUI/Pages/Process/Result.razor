@page "/process/result"
@using WebUI.Services
@inject ProjectService ProjectService
@inject PivotService PivotService
@inject ReportService ReportService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<PageTitle>ICP - Final Results</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Elevation="0" Class="pa-4 mb-4">
        <div class="d-flex justify-space-between align-center">
            <div>
                <MudText Typo="Typo.h4" Class="fw-bold">Final Results</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    View and export processed data with all corrections applied
                </MudText>
            </div>
            <ProcessNav CurrentStep="result" />
        </div>
    </MudPaper>

    @if (_projectId == null)
    {
        <MudAlert Severity="Severity.Warning">
            Please select a project first.
        </MudAlert>
    }
    else
    {
        <MudGrid>
            @* Controls Panel *@
            <MudItem xs="12" md="3">
                <MudPaper Elevation="2" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.FilterAlt" Class="me-2" />
                        Data Filters
                    </MudText>

                    <MudCheckBox @bind-Value="_showOnlyRm"
                                 Label="Show Only RM Samples"
                                 Color="Color.Primary"
                                 Class="mb-2" />

                    <MudCheckBox @bind-Value="_showBadSamples"
                                 Label="Highlight Bad Samples"
                                 Color="Color.Warning"
                                 Class="mb-2" />

                    <MudCheckBox @bind-Value="_showDiff"
                                 Label="Show Diff Columns"
                                 Color="Color.Info"
                                 Class="mb-4" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="LoadData"
                               Disabled="_isLoading"
                               Class="mb-4">
                        Refresh Data
                    </MudButton>

                    <MudDivider Class="my-4" />

                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Download" Class="me-2" />
                        Export
                    </MudText>

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Success"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.TableChart"
                               OnClick="@(() => ExportData("excel"))"
                               Disabled="_isLoading"
                               Class="mb-2">
                        Export Excel
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Info"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Description"
                               OnClick="@(() => ExportData("csv"))"
                               Disabled="_isLoading"
                               Class="mb-2">
                        Export CSV
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.DataObject"
                               OnClick="@(() => ExportData("json"))"
                               Disabled="_isLoading"
                               Class="mb-2">
                        Export JSON
                    </MudButton>
                </MudPaper>

                @* Summary Statistics *@
                <MudPaper Elevation="2" Class="pa-4 mt-4">
                    <MudText Typo="Typo.h6" Class="mb-2">Summary</MudText>
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex justify-space-between">
                            <span>Total Samples:</span>
                            <MudChip T="string" Size="Size.Small">@_totalSamples</MudChip>
                        </div>
                        <div class="d-flex justify-space-between">
                            <span>RM Samples:</span>
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">@_rmSamples</MudChip>
                        </div>
                        <div class="d-flex justify-space-between">
                            <span>Bad Samples:</span>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">@_badSamples</MudChip>
                        </div>
                        <div class="d-flex justify-space-between">
                            <span>Pass Rate:</span>
                            <MudChip T="string" Size="Size.Small" Color="@(_passRate >= 90 ? Color.Success : Color.Warning)">
                                @_passRate.ToString("F1")%
                            </MudChip>
                        </div>
                    </div>
                </MudPaper>
            </MudItem>

            @* Results Table *@
            <MudItem xs="12" md="9">
                <MudPaper Elevation="2" Class="pa-4">
                    @if (_isLoading)
                    {
                        <div class="d-flex justify-center align-center" style="min-height: 400px;">
                            <MudProgressCircular Indeterminate="true" Size="Size.Large" />
                        </div>
                    }
                    else if (_rows.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info">
                            No data available. Make sure all processing steps are complete.
                        </MudAlert>
                    }
                    else
                    {
                        <MudTable Items="@_pagedRows"
                                  Hover="true"
                                  Dense="true"
                                  FixedHeader="true"
                                  Height="500px"
                                  SortLabel="Sort By"
                                  Class="mb-4">
                            <HeaderContent>
                                <MudTh><MudTableSortLabel SortBy="new Func<ResultRow, object>(x => x.RowNumber)">Row</MudTableSortLabel></MudTh>
                                <MudTh><MudTableSortLabel SortBy="new Func<ResultRow, object>(x => x.SolutionLabel)">Solution Label</MudTableSortLabel></MudTh>
                                <MudTh><MudTableSortLabel SortBy="new Func<ResultRow, object>(x => x.SampleType)">Type</MudTableSortLabel></MudTh>
                                @foreach (var col in _elementColumns)
                                {
                                    <MudTh>@col</MudTh>
                                    @if (_showDiff)
                                    {
                                        <MudTh Style="background-color: #e3f2fd;">@(col + " Diff")</MudTh>
                                    }
                                }
                                <MudTh>Status</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd Style="@GetRowStyle(context)">@context.RowNumber</MudTd>
                                <MudTd Style="@GetRowStyle(context)">
                                    <MudText Class="fw-medium">@context.SolutionLabel</MudText>
                                </MudTd>
                                <MudTd Style="@GetRowStyle(context)">
                                    @if (context.SampleType == "RM")
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">RM</MudChip>
                                    }
                                    else if (context.SampleType == "STD")
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">STD</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Size="Size.Small">@context.SampleType</MudChip>
                                    }
                                </MudTd>
                                @foreach (var col in _elementColumns)
                                {
                                    var val = context.Values.GetValueOrDefault(col, 0);
                                    <MudTd Style="@GetRowStyle(context)">@val.ToString("F4")</MudTd>
                                    @if (_showDiff)
                                    {
                                        var diff = context.Diffs.GetValueOrDefault(col, 0);
                                        var diffColor = Math.Abs(diff) <= 10 ? "green" : "red";
                                        <MudTd Style="@($"background-color: #e3f2fd; color: {diffColor}")">
                                            @diff.ToString("F2")%
                                        </MudTd>
                                    }
                                }
                                <MudTd Style="@GetRowStyle(context)">
                                    @if (context.IsBad)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Small" />
                                    }
                                    else if (context.SampleType == "RM")
                                    {
                                        @if (context.PassedCount == context.TotalElements)
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.caption">@context.PassedCount/@context.TotalElements</MudText>
                                        }
                                    }
                                </MudTd>
                            </RowTemplate>
                            <PagerContent>
                                <MudTablePager PageSizeOptions="new int[] { 50, 100, 200, 500 }" />
                            </PagerContent>
                        </MudTable>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [SupplyParameterFromQuery]
    public Guid? projectId { get; set; }

    private Guid? _projectId;
    private List<ResultRow> _rows = new();
    private List<ResultRow> _pagedRows = new();
    private List<string> _elementColumns = new();
    private bool _showOnlyRm = false;
    private bool _showBadSamples = true;
    private bool _showDiff = false;
    private bool _isLoading = false;
    private int _totalSamples = 0;
    private int _rmSamples = 0;
    private int _badSamples = 0;
    private decimal _passRate = 0;

    protected override async Task OnInitializedAsync()
    {
        _projectId = projectId ?? ProjectService.CurrentProjectId;
        if (_projectId.HasValue)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        if (_projectId == null) return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            var request = new PivotRequest { ProjectId = _projectId.Value, PageSize = 10000 };
            var result = await PivotService.GetPivotTableAsync(request);
            if (result.Succeeded && result.Data != null)
            {
                var elements = await PivotService.GetElementsAsync(_projectId.Value);
                _elementColumns = elements.Data ?? new List<string>();

                _rows.Clear();
                int rowNum = 1;
                int passed = 0;
                int totalRm = 0;

                foreach (var row in result.Data.Rows)
                {
                    var resultRow = new ResultRow
                    {
                        RowNumber = rowNum++,
                        SolutionLabel = row.SolutionLabel,
                        SampleType = DetermineSampleType(row),
                        IsBad = DetermineIfBad(row),
                        TotalElements = _elementColumns.Count
                    };

                    foreach (var col in _elementColumns)
                    {
                        if (row.Values.TryGetValue(col, out var val) && val.HasValue)
                        {
                            resultRow.Values[col] = val.Value;
                        }

                        if (row.Values.TryGetValue(col + "_Diff", out var diff) && diff.HasValue)
                        {
                            resultRow.Diffs[col] = diff.Value;
                            if (Math.Abs(diff.Value) <= 10) resultRow.PassedCount++;
                        }
                        else if (row.Values.TryGetValue($"Diff_{col}", out var diff2) && diff2.HasValue)
                        {
                            resultRow.Diffs[col] = diff2.Value;
                            if (Math.Abs(diff2.Value) <= 10) resultRow.PassedCount++;
                        }
                    }

                    _rows.Add(resultRow);

                    if (resultRow.SampleType == "RM")
                    {
                        totalRm++;
                        if (resultRow.PassedCount == resultRow.TotalElements) passed++;
                    }
                }

                _totalSamples = _rows.Count;
                _rmSamples = _rows.Count(r => r.SampleType == "RM");
                _badSamples = _rows.Count(r => r.IsBad);
                _passRate = totalRm > 0 ? (decimal)passed / totalRm * 100 : 0;

                ApplyFilters();
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        var filtered = _rows.AsEnumerable();
        if (_showOnlyRm)
        {
            filtered = filtered.Where(r => r.SampleType == "RM");
        }
        _pagedRows = filtered.ToList();
    }

    private string DetermineSampleType(PivotRowDto row)
    {
        var label = row.SolutionLabel ?? "";
        
        // Check if SampleType exists in values
        if (row.Values.TryGetValue("SampleType", out var sampleTypeVal) && sampleTypeVal.HasValue)
        {
            // SampleType might be stored as numeric index
            return sampleTypeVal.Value switch
            {
                1 => "RM",
                2 => "STD",
                3 => "BLK",
                _ => "Sample"
            };
        }

        if (label.Contains("RM", StringComparison.OrdinalIgnoreCase)) return "RM";
        if (label.Contains("STD", StringComparison.OrdinalIgnoreCase)) return "STD";
        if (label.Contains("BLK", StringComparison.OrdinalIgnoreCase)) return "BLK";
        return "Sample";
    }

    private bool DetermineIfBad(PivotRowDto row)
    {
        if (row.Values.TryGetValue("IsBad", out var isBad) && isBad.HasValue && isBad.Value == 1) return true;
        if (row.Values.TryGetValue("BadWeight", out var bw) && bw.HasValue && bw.Value == 1) return true;
        if (row.Values.TryGetValue("BadVolume", out var bv) && bv.HasValue && bv.Value == 1) return true;
        if (row.Values.TryGetValue("IsEmpty", out var empty) && empty.HasValue && empty.Value == 1) return true;
        return false;
    }

    private string GetRowStyle(ResultRow row)
    {
        if (_showBadSamples && row.IsBad)
            return "background-color: #ffebee;";
        if (row.SampleType == "RM")
            return "background-color: #e3f2fd;";
        return "";
    }

    private async Task ExportData(string format)
    {
        if (_projectId == null) return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            var request = new ReportRequest
            {
                ProjectId = _projectId.Value,
                Format = format,
                IncludeSummary = true,
                IncludeCharts = false
            };

            var result = await ReportService.GenerateReportAsync(request);
            if (result.Succeeded && result.Data != null)
            {
                await JSRuntime.InvokeVoidAsync("downloadFile", result.Data.FileName, result.Data.ContentType, result.Data.Base64Data);
                Snackbar.Add($"Exported to {format.ToUpper()}", Severity.Success);
            }
            else
            {
                Snackbar.Add(result.Message ?? $"Export to {format} failed", Severity.Error);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    public class ResultRow
    {
        public int RowNumber { get; set; }
        public string SolutionLabel { get; set; } = "";
        public string SampleType { get; set; } = "";
        public bool IsBad { get; set; }
        public int PassedCount { get; set; }
        public int TotalElements { get; set; }
        public Dictionary<string, decimal> Values { get; set; } = new();
        public Dictionary<string, decimal> Diffs { get; set; } = new();
    }
}
