@page "/process/volume"
@using WebUI.Services
@inject ProjectService ProjectService
@inject CorrectionService CorrectionService
@inject ISnackbar Snackbar

<PageTitle>ICP - Volume Check</PageTitle>
<NavigationLock OnBeforeInternalNavigation="OnBeforeNavigation" ConfirmExternalNavigation="_isApplying" />
@* Loading Overlay *@
@if (_isApplying || _isLoading)
{
    <div class="loading-overlay">
        <MudPaper Elevation="4" Class="pa-6 d-flex flex-column align-center">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Class="mt-4">Processing...</MudText>
            
        </MudPaper>
    </div>
}

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Elevation="0" Class="pa-4 mb-4 custom-card-all">
        <div class="d-flex justify-space-between align-center">
            <div>
                <MudText Typo="Typo.h4" Class="fw-bold">Volume Check</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    @if (!string.IsNullOrEmpty(_projectName))
                    {
                        <span>Project: <strong>@_projectName</strong> | </span>
                    }
                    Find and correct samples with incorrect volumes
                </MudText>
            </div>
            <ProcessNav CurrentStep="volume" />
        </div>
    </MudPaper>

    @if (_projectId == null)
    {
        <MudAlert Severity="Severity.Warning">
            Please select a project first. <MudLink Href="/projects">Go to Projects</MudLink>
        </MudAlert>
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudPaper Elevation="0" Class="pa-4 custom-card-all">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Settings" Class="me-2" />
                        Settings
                    </MudText>

                    <MudNumericField @bind-Value="_expectedVolume"
                                     Label="Expected Volume (mL)"
                                     Variant="Variant.Outlined"
                                     Step="1M"
                                     Class="mb-4" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Search"
                               OnClick="FindBadVolumes"
                               Disabled="@(_isLoading || _isApplying)">
                               @* Disabled="_isLoading"> *@
                        @if (_isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                        }
                        Find Bad Volumes
                    </MudButton>

                    @if (_badSamples != null && _badSamples.Any())
                    {
                        <MudDivider Class="my-4" />

                        <MudNumericField @bind-Value="_newVolume"
                                         Label="New Volume (mL)"
                                         Variant="Variant.Outlined"
                                         Step="1M"
                                         Class="mb-4" />

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Build"
                                   OnClick="ApplyCorrection"
                                   Disabled="@(!_selectedSamples.Any() || _isApplying)">
                            Apply to Selected (@_selectedSamples.Count)
                        </MudButton>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="8">
                <MudPaper Elevation="0" Class="pa-4 height-75 custom-card-all">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Class="me-2" />
                        Bad Volume Samples
                        @if (_badSamples != null)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error" Class="ms-2">
                                @_badSamples.Count found
                            </MudChip>
                        }
                    </MudText>

                    @if (_badSamples == null)
                    {
                        <MudAlert Severity="Severity.Info">
                            Click "Find Bad Volumes" to search for samples with incorrect volumes.
                        </MudAlert>
                    }
                    else if (!_badSamples.Any())
                    {
                        <MudAlert Severity="Severity.Success">
                            All samples have correct volumes!
                        </MudAlert>
                    }
                    else
                    {
                        <MudTable Items="@_badSamples"
                                  Hover="true"
                                  Class="height-inner"
                                  Dense="true"
                                  MultiSelection="true"
                                  @bind-SelectedItems="_selectedSamples">
                            <HeaderContent>
                                <MudTh>Solution Label</MudTh>
                                <MudTh>Actual Volume</MudTh>
                                <MudTh>Expected</MudTh>
                                <MudTh>Deviation</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.SolutionLabel</MudTd>
                                <MudTd><MudText Color="Color.Error">@context.ActualValue.ToString("F2")</MudText></MudTd>
                                <MudTd>@context.ExpectedValue.ToString("F2")</MudTd>
                                <MudTd>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning">
                                        @context.Deviation.ToString("F1")%
                                    </MudChip>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                        <div class="d-flex justify-end mt-4 gap-2">
                            <MudButton Variant="Variant.Outlined"
                                       Size="Size.Small"
                                       Disabled="@(_isLoading || _isApplying)"
                                       OnClick="SelectAll">
                                Select All
                            </MudButton>
                            <MudButton Variant="Variant.Outlined"
                                       Size="Size.Small"
                                       Disabled="@(_isLoading || _isApplying)"
                                       OnClick="ClearSelection">
                                Clear Selection
                            </MudButton>
                        </div>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>
<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
</style>
    @code {
    [SupplyParameterFromQuery]
    public Guid? projectId { get; set; }

    private Guid? _projectId;
    private string? _projectName;
    private decimal _expectedVolume = 50m;
    private decimal _newVolume = 50m;
    private List<BadSampleDto>? _badSamples;
    private HashSet<BadSampleDto> _selectedSamples = new();
    private bool _isLoading = false;
    private bool _isApplying = false;

    protected override async Task OnInitializedAsync()
    {
        _projectId = projectId ?? ProjectService.CurrentProjectId;
        if (_projectId.HasValue)
        {
            var result = await ProjectService.GetProjectAsync(_projectId.Value);
            if (result.Succeeded && result.Data != null)
            {
                _projectName = result.Data.ProjectName;
            }
        }
    }

    private async Task FindBadVolumes()
    {
        if (_projectId == null) return;

        _isLoading = true;
        StateHasChanged();

        var result = await CorrectionService.FindBadVolumesAsync(_projectId.Value, _expectedVolume);

        if (result.Succeeded && result.Data != null)
        {
            _badSamples = result.Data;
        }
        else
        {
            Snackbar.Add(result.Message ?? "Failed", Severity.Error);
            _badSamples = new();
        }

        _isLoading = false;
    }

    private async Task ApplyCorrection()
    {
        
        if (_projectId == null || !_selectedSamples.Any()) return;

        _isApplying = true;

        var labels = _selectedSamples.Select(s => s.SolutionLabel).ToList();
        var result = await CorrectionService.ApplyVolumeCorrectionAsync(_projectId.Value, labels, _newVolume);

        if (result.Succeeded)
        {
            Snackbar.Add($"Corrected {result.Data?.CorrectedRows ?? 0} samples", Severity.Success);
            await FindBadVolumes();
        }
        else
        {
            Snackbar.Add(result.Message ?? "Failed", Severity.Error);
        }

        _isApplying = false;
    }

    private void SelectAll()
    {
        if (_badSamples != null)
        {
            _selectedSamples = new HashSet<BadSampleDto>(_badSamples);
        }
    }

    private void ClearSelection()
    {
        _selectedSamples.Clear();
    }
    private async Task OnBeforeNavigation(LocationChangingContext context)
    {
        if (_isApplying)
        {
            context.PreventNavigation();
        }
    }
}
