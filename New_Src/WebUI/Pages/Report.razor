@page "/report"
@using WebUI.Services
@inject ProjectService ProjectService
@inject ReportService ReportService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<PageTitle>ICP - Reports</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Elevation="0" Class="pa-4 mb-4">
        <div class="d-flex justify-space-between align-center">
            <div>
                <MudText Typo="Typo.h4" Class="fw-bold">Reports</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    Generate and export analysis reports
                </MudText>
            </div>
        </div>
    </MudPaper>

    @if (_projectId == null)
    {
        <MudAlert Severity="Severity.Warning">
            Please select a project first.
        </MudAlert>
    }
    else
    {
        <MudGrid>
            @* Report Options *@
            <MudItem xs="12" md="4">
                <MudPaper Elevation="2" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Settings" Class="me-2" />
                        Report Options
                    </MudText>

                    <MudSelect T="string"
                               Label="Report Format"
                               @bind-Value="_selectedFormat"
                               Variant="Variant.Outlined"
                               Class="mb-4">
                        <MudSelectItem Value="@("excel")">Excel (.xlsx)</MudSelectItem>
                        <MudSelectItem Value="@("csv")">CSV (.csv)</MudSelectItem>
                        <MudSelectItem Value="@("json")">JSON (.json)</MudSelectItem>
                        <MudSelectItem Value="@("pdf")">PDF (.pdf)</MudSelectItem>
                    </MudSelect>

                    <MudText Typo="Typo.subtitle2" Class="mb-2">Include Sections</MudText>

                    <MudCheckBox @bind-Value="_includeSummary"
                                 Label="Summary Statistics"
                                 Color="Color.Primary"
                                 Class="mb-1" />

                    <MudCheckBox @bind-Value="_includeRawData"
                                 Label="Raw Data"
                                 Color="Color.Primary"
                                 Class="mb-1" />

                    <MudCheckBox @bind-Value="_includeProcessedData"
                                 Label="Processed Data"
                                 Color="Color.Primary"
                                 Class="mb-1" />

                    <MudCheckBox @bind-Value="_includeCrmAnalysis"
                                 Label="CRM Analysis"
                                 Color="Color.Primary"
                                 Class="mb-1" />

                    <MudCheckBox @bind-Value="_includeDriftAnalysis"
                                 Label="Drift Analysis"
                                 Color="Color.Primary"
                                 Class="mb-1" />

                    <MudCheckBox @bind-Value="_includeCharts"
                                 Label="Charts & Visualizations"
                                 Color="Color.Primary"
                                 Class="mb-4" />

                    <MudDivider Class="my-4" />

                    <MudText Typo="Typo.subtitle2" Class="mb-2">Filter Elements</MudText>
                    <MudSelect T="string"
                               Label="Elements"
                               MultiSelection="true"
                               @bind-SelectedValues="_selectedElements"
                               Variant="Variant.Outlined"
                               Class="mb-4">
                        @foreach (var el in _allElements)
                        {
                            <MudSelectItem Value="@el">@el</MudSelectItem>
                        }
                    </MudSelect>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.FileDownload"
                               OnClick="GenerateReport"
                               Disabled="_isGenerating"
                               Class="mb-2">
                        @if (_isGenerating)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                            <span>Generating...</span>
                        }
                        else
                        {
                            <span>Generate Report</span>
                        }
                    </MudButton>
                </MudPaper>
            </MudItem>

            @* Report Templates *@
            <MudItem xs="12" md="8">
                <MudPaper Elevation="2" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Description" Class="me-2" />
                        Quick Report Templates
                    </MudText>

                    <MudGrid>
                        @* Full Report *@
                        <MudItem xs="12" md="6">
                            <MudCard Elevation="1">
                                <MudCardContent>
                                    <div class="d-flex align-center mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Summarize" Color="Color.Primary" Class="me-2" />
                                        <MudText Typo="Typo.h6">Full Analysis Report</MudText>
                                    </div>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                        Complete report with all data, statistics, CRM analysis, drift corrections, and charts.
                                    </MudText>
                                </MudCardContent>
                                <MudCardActions>
                                    <MudButton Variant="Variant.Text"
                                               Color="Color.Primary"
                                               OnClick="@(() => GenerateQuickReport("full"))">
                                        Generate
                                    </MudButton>
                                </MudCardActions>
                            </MudCard>
                        </MudItem>

                        @* CRM Report *@
                        <MudItem xs="12" md="6">
                            <MudCard Elevation="1">
                                <MudCardContent>
                                    <div class="d-flex align-center mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Science" Color="Color.Secondary" Class="me-2" />
                                        <MudText Typo="Typo.h6">CRM Validation Report</MudText>
                                    </div>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                        Report focusing on CRM samples, pass/fail rates, and calibration results.
                                    </MudText>
                                </MudCardContent>
                                <MudCardActions>
                                    <MudButton Variant="Variant.Text"
                                               Color="Color.Secondary"
                                               OnClick="@(() => GenerateQuickReport("crm"))">
                                        Generate
                                    </MudButton>
                                </MudCardActions>
                            </MudCard>
                        </MudItem>

                        @* Drift Report *@
                        <MudItem xs="12" md="6">
                            <MudCard Elevation="1">
                                <MudCardContent>
                                    <div class="d-flex align-center mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Warning" Class="me-2" />
                                        <MudText Typo="Typo.h6">Drift Analysis Report</MudText>
                                    </div>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                        Detailed drift analysis with segment detection and correction factors.
                                    </MudText>
                                </MudCardContent>
                                <MudCardActions>
                                    <MudButton Variant="Variant.Text"
                                               Color="Color.Warning"
                                               OnClick="@(() => GenerateQuickReport("drift"))">
                                        Generate
                                    </MudButton>
                                </MudCardActions>
                            </MudCard>
                        </MudItem>

                        @* Data Export *@
                        <MudItem xs="12" md="6">
                            <MudCard Elevation="1">
                                <MudCardContent>
                                    <div class="d-flex align-center mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.TableChart" Color="Color.Info" Class="me-2" />
                                        <MudText Typo="Typo.h6">Data Export</MudText>
                                    </div>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                        Export processed data in various formats without additional analysis.
                                    </MudText>
                                </MudCardContent>
                                <MudCardActions>
                                    <MudButton Variant="Variant.Text"
                                               Color="Color.Info"
                                               OnClick="@(() => GenerateQuickReport("data"))">
                                        Generate
                                    </MudButton>
                                </MudCardActions>
                            </MudCard>
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                @* Recent Reports *@
                <MudPaper Elevation="2" Class="pa-4 mt-4">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.History" Class="me-2" />
                        Recent Reports
                    </MudText>

                    @if (_recentReports.Any())
                    {
                        <MudList T="ReportHistoryItem" Dense="true">
                            @foreach (var report in _recentReports)
                            {
                                <MudListItem Icon="@GetFormatIcon(report.Format)">
                                    <div class="d-flex justify-space-between align-center w-100">
                                        <div>
                                            <MudText>@report.FileName</MudText>
                                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                                @report.GeneratedAt.ToString("yyyy-MM-dd HH:mm")
                                            </MudText>
                                        </div>
                                        <MudIconButton Icon="@Icons.Material.Filled.Download"
                                                       Size="Size.Small"
                                                       Color="Color.Primary"
                                                       OnClick="@(() => DownloadReport(report))" />
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            No recent reports available.
                        </MudText>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [SupplyParameterFromQuery]
    public Guid? projectId { get; set; }

    private Guid? _projectId;
    private string _selectedFormat = "excel";
    private bool _includeSummary = true;
    private bool _includeRawData = false;
    private bool _includeProcessedData = true;
    private bool _includeCrmAnalysis = true;
    private bool _includeDriftAnalysis = true;
    private bool _includeCharts = false;
    private IEnumerable<string> _selectedElements = new HashSet<string>();
    private List<string> _allElements = new();
    private List<ReportHistoryItem> _recentReports = new();
    private bool _isGenerating = false;

    protected override async Task OnInitializedAsync()
    {
        _projectId = projectId ?? ProjectService.CurrentProjectId;
        if (_projectId.HasValue)
        {
            await LoadElements();
            await LoadRecentReports();
        }
    }

    private async Task LoadElements()
    {
        // Load elements from API
        _allElements = new List<string>
        {
            "SiO2", "Al2O3", "Fe2O3", "CaO", "MgO", "Na2O", "K2O", "TiO2", "P2O5", "MnO"
        };
    }

    private async Task LoadRecentReports()
    {
        // This would load from API in real implementation
        _recentReports = new List<ReportHistoryItem>();
    }

    private async Task GenerateReport()
    {
        if (_projectId == null) return;

        _isGenerating = true;
        StateHasChanged();

        try
        {
            var request = new ReportRequest
            {
                ProjectId = _projectId.Value,
                Format = _selectedFormat,
                IncludeSummary = _includeSummary,
                IncludeCharts = _includeCharts,
                Elements = _selectedElements.Any() ? _selectedElements.ToList() : null
            };

            var result = await ReportService.GenerateReportAsync(request);

            if (result.Succeeded && result.Data != null)
            {
                await JSRuntime.InvokeVoidAsync("downloadFile",
                    result.Data.FileName,
                    result.Data.ContentType,
                    result.Data.Base64Data);

                Snackbar.Add("Report generated successfully", Severity.Success);

                _recentReports.Insert(0, new ReportHistoryItem
                {
                    FileName = result.Data.FileName,
                    Format = _selectedFormat,
                    GeneratedAt = DateTime.Now
                });
            }
            else
            {
                Snackbar.Add(result.Message ?? "Failed to generate report", Severity.Error);
            }
        }
        finally
        {
            _isGenerating = false;
        }
    }

    private async Task GenerateQuickReport(string template)
    {
        switch (template)
        {
            case "full":
                _includeSummary = true;
                _includeRawData = true;
                _includeProcessedData = true;
                _includeCrmAnalysis = true;
                _includeDriftAnalysis = true;
                _includeCharts = true;
                break;
            case "crm":
                _includeSummary = true;
                _includeRawData = false;
                _includeProcessedData = false;
                _includeCrmAnalysis = true;
                _includeDriftAnalysis = false;
                _includeCharts = true;
                break;
            case "drift":
                _includeSummary = true;
                _includeRawData = false;
                _includeProcessedData = false;
                _includeCrmAnalysis = false;
                _includeDriftAnalysis = true;
                _includeCharts = true;
                break;
            case "data":
                _includeSummary = false;
                _includeRawData = false;
                _includeProcessedData = true;
                _includeCrmAnalysis = false;
                _includeDriftAnalysis = false;
                _includeCharts = false;
                break;
        }

        await GenerateReport();
    }

    private string GetFormatIcon(string format) => format switch
    {
        "excel" => Icons.Material.Filled.TableChart,
        "csv" => Icons.Material.Filled.Description,
        "json" => Icons.Material.Filled.DataObject,
        "pdf" => Icons.Material.Filled.PictureAsPdf,
        _ => Icons.Material.Filled.InsertDriveFile
    };

    private async Task DownloadReport(ReportHistoryItem report)
    {
        // Re-download from cached data or re-generate
        Snackbar.Add("Downloading...", Severity.Info);
    }

    public class ReportHistoryItem
    {
        public string FileName { get; set; } = "";
        public string Format { get; set; } = "";
        public DateTime GeneratedAt { get; set; }
    }
}
