@inherits LayoutComponentBase
@using WebUI.Services
@inject AuthService AuthService
@inject NavigationManager NavManager

<MudThemeProvider @bind-IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@{
    var user = AuthService.GetCurrentUser();
    var isAuthenticated = user?.IsAuthenticated ?? false;
    var isLoginPage = NavManager.Uri.Contains("/login") || NavManager.Uri.EndsWith("/");
}

@if (!isAuthenticated || isLoginPage)
{
    @Body
}
else
{
    <MudLayout>
        <!-- Top AppBar -->
        <MudAppBar Elevation="1" Class="header-color" Fixed="true">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="ToggleDrawer" />
            @* <MudIcon Icon="@Icons.Material.Filled.Science" Class="me-2" /> *@
            <img src="./Images/logo-RASF1.png" width="30" class="mr-2"/>
            <MudText Typo="Typo.h6" Class="fw-bold">RASF ICP Processing</MudText>
            <MudSpacer />
            <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" 
                           Color="Color.Inherit" 
                           OnClick="ToggleDarkMode" />
            <MudMenu Icon="@Icons.Material.Filled.Person" Color="Color.Inherit">
                <MudMenuItem Icon="@Icons.Material.Filled.Person">@(user?.Name ?? "User")</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.Badge">@(user?.Position ?? "User")</MudMenuItem>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Filled.Settings" OnClick="@(() => NavManager.NavigateTo("/settings"))">Settings</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="HandleLogout">Sign Out</MudMenuItem>
            </MudMenu>
        </MudAppBar>

        <!-- Sidebar Drawer -->
        <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2" Variant="DrawerVariant.Mini" OpenMiniOnHover="true">
            <MudNavMenu>
                <MudNavLink Href="/dashboard" Icon="@Icons.Material.Filled.Dashboard" Match="NavLinkMatch.All">
                    Dashboard
                </MudNavLink>
                <MudNavLink Href="/import" Icon="@Icons.Material.Filled.CloudUpload" Match="NavLinkMatch.All">
                    Import Data
                </MudNavLink>
                <MudNavLink Href="/projects" Icon="@Icons.Material.Filled.Folder" Match="NavLinkMatch.All">
                    Projects
                </MudNavLink>
                
                <MudDivider Class="my-2" />
                
                <MudNavGroup Title="Data" Icon="@Icons.Material.Filled.TableChart" Expanded="false">
                    <MudNavLink Href="/pivot" Icon="@Icons.Material.Filled.GridOn" Match="NavLinkMatch.All">
                        Pivot Table
                    </MudNavLink>
                    <MudNavLink Href="/elements" Icon="@Icons.Material.Filled.Category" Match="NavLinkMatch.All">
                        Elements
                    </MudNavLink>
                </MudNavGroup>
                
                <MudNavGroup Title="Process" Icon="@Icons.Material.Filled.Engineering" Expanded="false">
                    <MudNavLink Href="/process/weight" Icon="@Icons.Material.Filled.Scale" Match="NavLinkMatch.All">
                        Weight Check
                    </MudNavLink>
                    <MudNavLink Href="/process/volume" Icon="@Icons.Material.Filled.LocalDrink" Match="NavLinkMatch.All">
                        Volume Check
                    </MudNavLink>
                    <MudNavLink Href="/process/df" Icon="@Icons.Material.Filled.Functions" Match="NavLinkMatch.All">
                        DF Check
                    </MudNavLink>
                    <MudNavLink Href="/process/empty" Icon="@Icons.Material.Filled.RemoveCircleOutline" Match="NavLinkMatch.All">
                        Empty Check
                    </MudNavLink>
                    <MudNavLink Href="/process/drift" Icon="@Icons.Material.Filled.Timeline" Match="NavLinkMatch.All">
                        Drift Correction
                    </MudNavLink>
                </MudNavGroup>
                
                <MudNavLink Href="/crm" Icon="@Icons.Material.Filled.VerifiedUser" Match="NavLinkMatch.All">
                    CRM Database
                </MudNavLink>
                <MudNavLink Href="/report" Icon="@Icons.Material.Filled.Assessment" Match="NavLinkMatch.All">
                    Reports
                </MudNavLink>
                <MudNavLink Href="/changelog" Icon="@Icons.Material.Filled.History" Match="NavLinkMatch.All">
                    Change Log
                </MudNavLink>
            </MudNavMenu>
        </MudDrawer>

        <!-- Main Content -->
        <MudMainContent Class="pt-16">
            <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
                @Body
            </MudContainer>
        </MudMainContent>
    </MudLayout>
}

@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = false;

    private void ToggleDrawer() => _drawerOpen = !_drawerOpen;
    private void ToggleDarkMode() => _isDarkMode = !_isDarkMode;

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        NavManager.NavigateTo("/login");
    }
}