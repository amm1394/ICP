@inherits LayoutComponentBase
@using WebUI.Services
@inject AuthService AuthService
@inject NavigationManager NavManager

<MudThemeProvider Theme="_theme" IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@if (_isAuthenticated)
{
    <MudLayout>
        <MudAppBar Elevation="1" Dense="true" Color="Color.Primary">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                           Color="Color.Inherit" 
                           Edge="Edge.Start" 
                           OnClick="@ToggleDrawer" />
            
            <MudImage Src="Images/logo-RASF1.png" Height="32" Class="me-3" />
            <MudText Typo="Typo.h6" Class="d-none d-sm-flex">RASF ICP Processing</MudText>
            
            <MudSpacer />

            @if (_currentProject != null)
            {
                <MudChip T="string" Color="Color.Secondary" Size="Size.Small" Class="me-4">
                    <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="me-1" />
                    @_currentProject
                </MudChip>
            }

            <MudTooltip Text="@(_isDarkMode ? "Light Mode" : "Dark Mode")">
                <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" 
                               Color="Color.Inherit" 
                               OnClick="@ToggleDarkMode" />
            </MudTooltip>

            <MudMenu Icon="@Icons.Material.Filled.Person" Color="Color.Inherit" Dense="true">
                <ChildContent>
                    <MudMenuItem Disabled="true">
                        <div class="d-flex flex-column">
                            <MudText Typo="Typo.subtitle2">@_userName</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">@_userPosition</MudText>
                        </div>
                    </MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Icon="@Icons.Material.Filled.Settings" OnClick="OpenSettings">Settings</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="Logout">Logout</MudMenuItem>
                </ChildContent>
            </MudMenu>
        </MudAppBar>

        <MudDrawer @bind-Open="_drawerOpen" 
                   ClipMode="DrawerClipMode.Always" 
                   Elevation="2"
                   Variant="@DrawerVariant.Mini"
                   OpenMiniOnHover="true">
            <MudNavMenu>
                <MudNavLink Href="/dashboard" Icon="@Icons.Material.Filled.Dashboard" Match="NavLinkMatch.All">
                    Dashboard
                </MudNavLink>
                
                <MudNavLink Href="/import" Icon="@Icons.Material.Filled.CloudUpload">
                    Import Data
                </MudNavLink>
                
                <MudNavLink Href="/projects" Icon="@Icons.Material.Filled.FolderOpen">
                    Projects
                </MudNavLink>

                <MudDivider Class="my-2" />
                
                <MudNavGroup Title="Data" Icon="@Icons.Material.Filled.TableChart" Expanded="true">
                    <MudNavLink Href="/pivot" Icon="@Icons.Material.Filled.ViewModule">Pivot Table</MudNavLink>
                    <MudNavLink Href="/elements" Icon="@Icons.Material.Filled.Science">Elements</MudNavLink>
                </MudNavGroup>

                <MudNavGroup Title="Process" Icon="@Icons.Material.Filled.Engineering" Expanded="false">
                    <MudNavLink Href="/process/weight" Icon="@Icons.Material.Filled.FitnessCenter">Weight Check</MudNavLink>
                    <MudNavLink Href="/process/volume" Icon="@Icons.Material.Filled.Water">Volume Check</MudNavLink>
                    <MudNavLink Href="/process/df" Icon="@Icons.Material.Filled.Compress">DF Check</MudNavLink>
                    <MudNavLink Href="/process/empty" Icon="@Icons.Material.Filled.RemoveCircleOutline">Empty Check</MudNavLink>
                    <MudNavLink Href="/process/crm" Icon="@Icons.Material.Filled.Verified">CRM Calibration</MudNavLink>
                    <MudNavLink Href="/process/drift" Icon="@Icons.Material.Filled.TrendingUp">Drift Correction</MudNavLink>
                    <MudNavLink Href="/process/result" Icon="@Icons.Material.Filled.CheckCircle">Results</MudNavLink>
                </MudNavGroup>

                <MudNavLink Href="/crm" Icon="@Icons.Material.Filled.FactCheck">
                    CRM Database
                </MudNavLink>

                <MudDivider Class="my-2" />

                <MudNavLink Href="/report" Icon="@Icons.Material.Filled.Assessment">
                    Reports
                </MudNavLink>
                
                <MudNavLink Href="/changelog" Icon="@Icons.Material.Filled.History">
                    Change Log
                </MudNavLink>
            </MudNavMenu>
        </MudDrawer>

        <MudMainContent Class="pt-16 px-4">
            @Body
        </MudMainContent>
    </MudLayout>
}
else
{
    <MudLayout>
        @Body
    </MudLayout>
}

@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = false;
    private bool _isAuthenticated = false;
    private string _userName = "User";
    private string _userPosition = "User";
    private string? _currentProject;

    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#1976D2",
            Secondary = "#388E3C",
            Tertiary = "#7B1FA2",
            AppbarBackground = "#1565C0",
            Background = "#F5F5F5",
            Surface = "#FFFFFF",
            DrawerBackground = "#FAFAFA",
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#90CAF9",
            Secondary = "#A5D6A7",
            Tertiary = "#CE93D8",
            AppbarBackground = "#1E1E1E",
            Background = "#121212",
            Surface = "#1E1E1E",
            DrawerBackground = "#1E1E1E",
        },
        Typography = new Typography()
        {
            Default = new DefaultTypography()
            {
                FontFamily = new[] { "Inter", "Segoe UI", "Roboto", "sans-serif" }
            }
        }
    };

    protected override void OnInitialized()
    {
        var user = AuthService.GetCurrentUser();
        if (user != null && user.IsAuthenticated)
        {
            _isAuthenticated = true;
            _userName = user.Name;
            _userPosition = user.Position;
        }

        NavManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        var uri = new Uri(e.Location);
        if (uri.AbsolutePath == "/" || uri.AbsolutePath == "/login")
        {
            _isAuthenticated = false;
        }
        else
        {
            var user = AuthService.GetCurrentUser();
            _isAuthenticated = user?.IsAuthenticated ?? false;
            if (_isAuthenticated)
            {
                _userName = user!.Name;
                _userPosition = user.Position;
            }
        }
        StateHasChanged();
    }

    private void ToggleDrawer() => _drawerOpen = !_drawerOpen;
    
    private void ToggleDarkMode() => _isDarkMode = !_isDarkMode;

    private void OpenSettings() => NavManager.NavigateTo("/settings");

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        _isAuthenticated = false;
        NavManager.NavigateTo("/login");
    }

    public void SetCurrentProject(string? projectName)
    {
        _currentProject = projectName;
        StateHasChanged();
    }

    public void Dispose()
    {
        NavManager.LocationChanged -= OnLocationChanged;
    }
}