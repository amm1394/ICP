@inherits LayoutComponentBase
@inject NavigationManager NavManager
@inject AuthService AuthService

<MudThemeProvider Theme="@_theme" IsDarkMode="isDarkMode">
    <MudPopoverProvider />
    <MudDialogProvider />
    <MudSnackbarProvider />

    <MudLayout>
        <MudAppBar Elevation="1" Dense="true" Class="appbar">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="ToggleDrawer" />
            <MudText Typo="Typo.h6" Class="mud-text-primary">ICP Control Center</MudText>
            <MudSpacer />

            <MudIcon Icon="@Icons.Material.Filled.LightMode" Color="Color.Default" Class="me-2" />
            <MudSwitch Color="Color.Primary" @bind-Checked="isDarkMode" aria-label="Toggle theme" />

            <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                <ActivatorContent>
                    <MudButton Variant="Variant.Text" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.AccountCircle">
                        @CurrentUserLabel
                    </MudButton>
                </ActivatorContent>
                <MudMenuItem OnClick="NavigateToProfile">Profile</MudMenuItem>
                <MudMenuItem OnClick="HandleLogout">Logout</MudMenuItem>
            </MudMenu>
        </MudAppBar>

        <MudDrawer @bind-Open="drawerOpen" ClipMode="DrawerClipMode.Always" Variant="DrawerVariant.Responsive" Elevation="1" Class="drawer">
            <div class="drawer-header">
                <MudAvatar Icon="@Icons.Material.Filled.Science" Color="Color.Primary" Size="Size.Large" />
                <div>
                    <MudText Typo="Typo.subtitle1" Class="fw-bold">Isatis ICP</MudText>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Labs &amp; Analytics</MudText>
                </div>
            </div>
            <NavMenu />
        </MudDrawer>

        <MudMainContent Class="main-content">
            <div class="content-surface">
                @Body
            </div>
        </MudMainContent>
    </MudLayout>
</MudThemeProvider>

@code {
    private bool drawerOpen = true;
    private bool isDarkMode;

    private string CurrentUserLabel => AuthService.GetCurrentUser()?.Name ?? "Account";

    private readonly MudTheme _theme = new()
    {
        Palette = new PaletteLight
        {
            Primary = "#1C6397",
            Secondary = "#4cc2e6",
            Tertiary = "#00b2a9",
            Background = "#f6f8fb",
            Surface = "#ffffff",
            AppbarBackground = "#ffffff",
            TextPrimary = "#1f2937",
            DrawerBackground = "#0f172a",
            Success = "#22c55e",
            Info = "#3b82f6"
        },
        PaletteDark = new PaletteDark
        {
            Primary = "#4cc2e6",
            Secondary = "#9ad1ff",
            Background = "#0f172a",
            Surface = "#111827",
            AppbarBackground = "#0b1220"
        },
        LayoutProperties = new LayoutProperties
        {
            DefaultBorderRadius = "12px"
        },
        Typography = new Typography
        {
            Default = new Default
            {
                FontFamily = new[] { "'Inter'", "'Segoe UI'", "sans-serif" }
            }
        }
    };

    private void ToggleDrawer() => drawerOpen = !drawerOpen;

    private void NavigateToProfile() => NavManager.NavigateTo("/dashboard");

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        NavManager.NavigateTo("/login", true);
    }
}
